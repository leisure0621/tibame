<h1 id="top">目錄</h1>

- [1. POST 的方法](#s1)
- [2. request.setCharacterEncoding() 字元編碼處裡](#s2)

---

# <a id='s1' class='md-title' href='#top'>1. POST 的方法</a>

- form.html，[也可參照此檔](./doc/html/form.zip?target=_blank)

```html
<form method="post" action="HelloPost">
  請輸入您的名字!
  <input type="TEXT" name="name" value="peter1吳永志" />
  <p>
    <input type="SUBMIT" />
  </p>
</form>
```

- Hello.java，[也可參照此檔](./doc/java/Hello.java?target=_blank)

```java
public void doPost(HttpServletRequest req, HttpServletResponse res)
                          throws ServletException, IOException {
  // 讓 servlet 用 UTF-8 編碼
  req.setCharacterEncoding("UTF-8");
  res.setContentType("text/html; charset=UTF-8");
  PrintWriter out = res.getWriter();
  String name = req.getParameter("name");
}
```

- 但如果直接執行此 Hello.java 路徑的程式則會產生 405 的錯誤 (因為**連結預設是使用 get** 方式傳輸)
- **解法**: 先以 doGet 接收，在傳給 doPost

```java
public void doGet(HttpServletRequest req, HttpServletResponse res)
          throws ServletException, IOException {
  doPost(req, res);
}

public void doPost(HttpServletRequest req, HttpServletResponse res)
                          throws ServletException, IOException {

  req.setCharacterEncoding("UTF-8");
  res.setContentType("text/html; charset=UTF-8");
  String name = req.getParameter("name");
}
```

# <a id='s2' class='md-title' href='#top'>2. request.setCharacterEncoding() 字元編碼處裡</a>

- **Method = "POST"**
  - 使用 post 傳輸時若有<u>非西歐語系(ISO-8859-1)</u>，必須在執行程式碼前預先使用 request.setCharacterEncoding("特定呃字元編碼之字碼集"); 以特定字碼集(UTF-8 或 Big5)處裡
    - 此為 Servlet 2.3 開始癌有的統一規格 API
    - 只對 <u>method = "post"</u> 有效

```java
req.setCharacterEncoding("UTF-8"); // 須先進行處理
String name = req.getParameter("name");
```

- **Method = "GET"**
  - 當 <u>method = "get"</u> 時，須自行令做處理
  - Tomcat 8-9 開始，在接收 GET 請求傳過來的字串時如果是 UTF-8 時不需另外設定轉碼
  - 但如果是自訂接收的編碼格式的話，就需要另外做設定
    - Tomcat 8 及以上
      - **步驟 1**，設定 **server.xml**:
        Connector port="8080" protocol="HTTP/1.1"
        connectionTimeout="20000"
        redirectPort="8443"
        **useBodyEncodingForURL="true"**
      - **步驟 2** ，java 接收參數前添加 **req.setCharacterEncoding("...");**
        (讓參數發送時，可以自訂輸出的字元編碼，即與 post 靠攏)
    - Tomcat 8 以下
      - **String name = new String(getBytes(ISO-8859-1),UTF-8)**
  - **概觀**
    - Web server 對於 GET 請求參數(request parameter)的字元編碼(character encoding)，並無一個標準的定義
    - Apache Tomcat 是使用 ISO-8859-1 作為整個 URL 的預設字元編碼，包括查詢字元串(Get 參數)
    - 這將導致參數被不正當的解碼(如果他們包含了 ISO-8859-1 字元集外的任何字元)
    - 由於每個 Web Server 於 GET 之 request parameter (請求參數) 的字元編碼 (character encoding) 處理方式皆不同，所以需要查看該 Web server 文件檔的說明 (web server docs)
  - **解決方案**
    - 對於 Apache Tomcat 的具體解決方案有兩種，兩種都涉及到修改 **<span style='color:red;'>server.xml</span>** 文件中的 Connector 標籤內容
    - **方法 1**: Connector 中添加 **URIEncoding="..."**
      - 強迫所有 Get 請求參數使用特定字元編碼
      - 在 Tomcat 8-9 中，URIEncoding="UTF-8"是預設設定
      - 送出 GET 請求的任何網頁在 Tomcat 8-9 中都必須是以 UTF-8 送出
      - 即 GET 請求的 JSP 網頁，在 Tomcat 8-9 中都必須是以 UTF-8 送出
        `<%@page contentType="text/html;charset=UTF-8"%>`
    - **方法 2**: Connector 中添加 **useBodyEncodingForURI="true"**
      - 強迫在傳在傳送 GET 的請求參數時，<u>會使用和 POST 相同的字元編碼</u>
      - 也就是送出 GET 請求的任何網頁在 Tomcat 8-9 中就不必都必須是以 UTF-8 送出
      - 也就是說，送出 GET 請求的 JSP 網頁，在 Tomcat 8-9 中也可以自訂編碼方式送出
        `<%@page contentType="text/html;charset=Big5"%>`
      - 此方式支援 Tomcat 5.x ~ 9.x

```xml
<Connector port="8082" protocol="HTTP/1.1"
            connectionTimeout="20000"
            redirectPort="8443"
      useBodyEncodingForURI="true" />
```

---

參考鏈接:

- [response 乱码 response.setCharacterEncoding("UTF-8")不生效的原因及解决方法](https://blog.csdn.net/TLMS_/article/details/78749980)
- [request 和 response 的 setCharacterEncoding()方法](https://blog.csdn.net/kong_lev/article/details/73071198)
- [new String(getBytes(ISO-8859-1),UTF-8)中文编码避免乱码](https://blog.csdn.net/qq_28863045/article/details/79503945)
- [Tomcat 8 默认字符编码格式 UTF-8](https://www.jianshu.com/p/3c461ef12bfa)
