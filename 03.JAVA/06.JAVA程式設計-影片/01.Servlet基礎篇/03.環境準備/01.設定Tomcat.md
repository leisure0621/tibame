<h1 id="top">目錄</h1>

- [1. 安裝 JDK 及 Java 環境設定](#s1)
- [2. 下載 Tomcat](#s2)
- [3. 設定 Tomcat 組態檔](#s3)
- [4. PORT 號](#s4)

---

# <a id='s1' class='md-title' href='#top'>1. 安裝 JDK 及 Java 環境設定</a>

- **下載 JDK**
  - 至 http://java.sun.com 下載最新版的 JDK，或下載 **jdk-8u231**
  - 2010 年 Oracle 宣布併購 Sun Microsystems 之後:
    [原 Sun 官網](http://java.sun.com) 會導向 [Oracle 官網](http://www.oracle.com/technetwork/java/index.html)
- **安裝 JDK**
  - 執行下載的 JDK (**jdk-8uxx-windows-x64** ，或 **-i586** )**.exe** 已安裝 JDK (所有步驟皆 Next 即可)
- **安裝結果**
  - JDK: <u>C:ProgramFiles\Java\jdk1.8.0_xx</u>
  - JRE: <u>C:ProgramFiles\Java\jdk1.8.0_xx</u>
- **環境設定**
  - <u>我的電腦</u> > <u>右鍵</u> > <u>內容</u> > <u>進階</u> > <u>環境變數</u> > <u>下方的系統變數</u> > <u>按新增或編輯</u>
  - 新增或編輯:
    - **java_home**: `C:ProgramFiles\Java\jdk1.8.0_xx`
    - **path**: `%java_home%\bin;`...
    - **classpath**: `.;`...
- **測試結果**
  - <u>Windows 命令提示符介面(cmd)</u> > <u>輸入 java -version</u>
    顯示 <u>java version "1.8.0_xx"</u> 即表示環境設定完成
    若是環境設定前開了 cmd 環境，記得 重啟 cmd 再輸入指令

# <a id='s2' class='md-title' href='#top'>2. 下載 Tomcat</a>

- **下載 Tomcat**
  - 至 http://www.apache.org 下載最新版的 Tomcat，或可點此下載 [tomcat-8.5.57](./doc/apache/apache-tomcat-8.5.57.zip)
    - Servlet 版本與 Tomcat 版本
    - Servlet 2.4 的 Tomcat 5.x
    - Servlet 2.5 的 Tomcat 6.x
    - Servlet 3.0 的 Tomcat 7.x
    - Servlet 3.1 的 Tomcat 8.x
  - 至官網後找尋所需版本，下載 **Core** 標題中的 **zip**，此版本可以支援 32 與 64 位元的作業系統
  - 解壓縮後就可使用 Tomcat
- **startup**(啟用) 與 **shutdown**(關閉)
  - startup: 啟用伺服器
  - shutdown: 關閉伺服器 (使用此關閉方式，伺服器會呼叫 destory() )
    - destory() 會將**資源歸還**或**儲存自身狀態**
    - 假設伺服器因為 **<span style="color:red;">當機</span>** 而停止，則 **<span style="color:red;">destory</span>** 不會被呼叫

```cs
"C:\EA102_WebApp\apache-tomcat-9.0.35\bin\startup.bat"
```

```cs
"C:\EA102_WebApp\apache-tomcat-9.0.35\bin\shutdown.bat"
```

# <a id='s3' class='md-title' href='#top'>3. 設定 Tomcat 組態檔</a>

- `server.xml`: 修改 port 號 (預設 **port="8080"**，為了**避免 port 被占用**所以要修改)

```cs
"apache-tomcat-8.5.57\conf\server.xml"
```

```xml
<Connector port="8082" protocol="HTTP/1.1"
            connectionTimeout="20000"
            redirectPort="8443" />
```

- `tomcat-users.xml`: 新增使用者 (新增時要注意 **rolename="manager-gui"** 與 **roles="manager-gui"** 要正確)

```cs
"apache-tomcat-8.5.57\conf\tomcat-users.xml"
```

```xml
<role rolename="tomcat"/>
<role rolename="role1"/>
<!-- 增加這行，自訂使用者 -->
<role rolename="manager-gui"/>
<role rolename="manager-script"/>
<role rolename="admin-gui"/>

<user username="tomcat" password="tomcat" roles="tomcat"/>
<user username="both"   password="tomcat" roles="tomcat,role1"/>
<user username="role1"  password="tomcat" roles="role1"/>
<!-- 增加這行，自訂使用者 -->
<user username="manager-gui"    password="manager-gui"    roles="manager-gui"/>
<user username="manager-script" password="manager-script" roles="manager-script"/>
<user username="admin-gui"      password="admin-gui"      roles="admin-gui"/>
```

- `web.xml`: invoker 開發方便所以要修改 (**上線需還原成 false**，否則會有安全上問題)

```cs
"apache-tomcat-8.5.57\conf\web.xml"
```

```xml
<servlet>
    <servlet-name>default</servlet-name>
    <servlet-class>org.apache.catalina.servlets.DefaultServlet</servlet-class>
    <init-param>
        <param-name>debug</param-name>
        <param-value>0</param-value>
    </init-param>
    <init-param>
        <param-name>listings</param-name>
        <!-- 預設 false，為了測試要改為 true -->
        <param-value>true</param-value>
    </init-param>
    <load-on-startup>1</load-on-startup>
</servlet>
```

- `context.xml`: 專門為我們的 web 專案所設定的檔案 (tomcate 6 才有的新檔案，其中的設定可以幫助我們讓 servlet 重載入; 在檔案裡面有一項叫做 **Resource** 的部分為連**線池設定**，即可設置資料庫連線)

  **查詢設定連線池方式**: <u>localhost:808X</u> > <u>Documentation</u> > <u>Tomcat 8.X Documentation</u> > <u>JDBC DataSources</u> > <u>Oracle 8i, 9i & 10g</u>

```cs
"apache-tomcat-8.5.57\conf\context.xml"
```

```xml
<!-- 添加 antiResourceLocking="false" privileged="true" reloadable="true" crossContext="true" -->
<!--
  antiResourceLocking:
    false: 防止jar被鎖定而無法刪除，且會產生work(臨時目錄)
    true: 鎖定並防止jar被刪除
  privileged: 屬於一種特權運用設定
    true: 可使用 manager 應用的一系列操作
  reloadable:
    true: 自動檢測 /WEB-INF/lib 與 /WEB-INF/classes 的變化，實現熱部屬
  crossContext:
    true: 配置不同的 Context(專案) 共用一個 session
 -->
<Context antiResourceLocking="false" privleged="true" reloadable="true" crossContext="true">

    <!-- 添加連線池設定 -->
    <!--
          name: 連線名稱
          url: 資料庫連結 (:@127.0.0.1:1521:mysid 記得改成當前設定的連線資料，例: 1521:xe)
          username: 使用者名稱
          password: 使用者密碼
        -->
    <Resource name="jdbc/TestDB" auth="Container"
              type="javax.sql.DataSource" driverClassName="oracle.jdbc.driver.OracleDriver"
              url="jdbc:oracle:thin:@localhost:1521:XE"
              username="102" password="123456" maxTotal="20" maxIdle="10"
              maxWaitMillis="-1"/>

...
```

<p><img src='./image/08.ServerXml資料庫配置.dio.svg'></p>

- `console 亂碼`:
  tomcat 9.0.14 開始內建 UTF-8 設定，造成伺服器啟動時控制台出現亂碼
  註解掉 UTF-8 這行就好

```cs
"apache-tomcat-8.5.57\conf\logging.properties"
```

```xml
# java.util.logging.ConsoleHandler.encoding = UTF-8
```

# <a id='s4' class='md-title' href='#top'>4. PORT 號</a>

- **可用的 Port 號**:
  - **有 2^16**: 65535
  - **0~1023**: 給全球通用的功能使用
  - **1024~65535**: 其他，或私人用
  - **一次可連線數**: 65535-1024+1 = 64512
- 如在多執行續環境執行，伺服器會將這麼多連線只當作一隻程式在運行，所以速度會很快

<table>			
<tr>	<th></th>	<th>Port</th>	</tr>
<tr>	<td>HTTP</td>	<td>80</td>	</tr>
<tr>	<td>Upload/Download</td>	<td>20/21</td>	</tr>
<tr>	<td>mailServer</td>	<td>25</td>	</tr>
<tr>	<td>oracle</td>	<td>1521</td>	</tr>
<tr>	<td>SQLServer</td>	<td>1433</td>	</tr>
<tr>	<td>MySQL</td>	<td>3306</td>	</tr>
</table>

---

參考鏈接:

- [Tomcat 与 JDK 版本对应关系，Tomcat 各版本特性](https://blog.csdn.net/ThinkWon/article/details/102622738)
- [tomcat antiResourceLocking antiJARLocking 的作用和用法](https://www.jb51.net/article/19472.htm)
- [啥，Tomcat 里竟然还有特权应用?](https://zhuanlan.zhihu.com/p/26781689)
- [Tomcat 常见部署方法](https://blog.csdn.net/yanjun008/article/details/41249481)
