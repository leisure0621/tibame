<h1 id="top">目錄</h1>

- [1. Java Servlet 的優勢](#s1)
- [2. 15 個取得瀏覽器請求時的動態路徑](#s2)
- [3. 3 個瀏覽器額外請求](#s3)
- [4. 物件實體 (object instance)](#s4)
- [5. 動態路徑設置 (getContextPath)](#s5)
- [6. 18 個瀏覽器請求測試](#s6)
- [7. 取得檔案路徑與檔案型態練習](#s7)

---

# <a id='s1' class='md-title' href='#top'>1. Java Servlet 的優勢</a>

- `效率與耐用性`
  - 不同於 CGI **只要 Servlet 被載入一次，其 object instance 即保存於伺服器的記憶體中**，可隨時再以執行緒處理方式接受下一個請求
  - 由於是以物件形式存在，故能自動維護自己的狀態，並持續保有外部資源(如保有資料庫連線，不必每次重新連線浪費資源）
  - **物件在記憶體中可以維持原狀態是 servlet 的第一個優勢**
- `整合性`
  - 與伺服器間的高度整合性，如利用伺服器來轉譯檔案路徑...等 CGI 無法達成的任務
- `安全性`
  - 除承襲 Java 原有的 strong type safety 外；伺服器甚至可用 Java 的 security manager 或 access controller 來保護自己，以免受 servlet 的傷害

# <a id='s2' class='md-title' href='#top'>2. 15 個取得瀏覽器請求時的動態路徑</a>

<p><img src='./image/03.JavaServlet的優勢.01.dio.svg'></p>

<p><img src='./image/03.JavaServlet的優勢.02.dio.svg'></p>

(13) `req.getContentType()`

- get
  - null
- post
  - 預設資料: application/x-www-form-urlencoded
  - 資料上傳: multipart/form-data

# <a id='s3' class='md-title' href='#top'>3. 3 個瀏覽器額外請求</a>

(16) `String context.getRealPath(String virtualpath)`

- 轉換指定的 virtualpath 為真實的檔案系統路徑(**該檔案位於本地機器內**)
- 如: **context.getRealPath("xx.gif")** = http://localhost:8080/myWebApp/PathServlet/xx.gif
- 用途: **檔案上傳**
- 幫客戶創建資料夾在專案路徑底下，接著可用 `getServletContext().getRealPath('/images')` 抓取路徑。抓取路徑: `C:\EA102_WebApp\apache-tomcat-9.0.35\webapps\IBM_9\`

(17) `java.net.URL context.getResource(String uripath)`

- 傳回指定的 uripath(uripath 需以`/`開頭)的 URL 物件 (可位於`本地機器`、`遠端`或`包在.war內`)
- 如: **context.getResource("/path1/1.html")**
- 取得 URL 物件後，可在呼叫 openStream()方法，以取得 java.io.InputStream 在行下一步處理 (`用的機會比較小`)

(18) `java.io.InputStream context.getResourceAstream(String uripath)`

- 如同前者的 **context.getResource("/path1/1.html").openStream()**

# <a id='s4' class='md-title' href='#top'>4. 物件實體 (object instance)</a>

- 因為 **Servlet 每載入一次，其 object instance 即保存於伺服器的記憶體中**，所以 `count` 數值會疊加
- out.println() 出的結果如果需要是網頁結構，則就要 `<html></html>` 的起始跟結束標籤
- 每實體化一次就會增加 count 的計數

```java
//package servlet_examples;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class HelloWorld extends HttpServlet {

  int count = 0;

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
    doPost(req, res);

  }

  public void doPost(HttpServletRequest req, HttpServletResponse res)
                                throws ServletException, IOException {

    res.setContentType("text/html; charset=Big5");
    PrintWriter out = res.getWriter();

    out.println("<HTML>");
    out.println("<HEAD><TITLE>Hello World</TITLE></HEAD>");
    out.println("<BODY>");
    out.println("<BIG>Hello World , 世界你好2 !</BIG>"+(++count));
    out.println("</BODY></HTML>");
  }
}
```

# <a id='s5' class='md-title' href='#top'>5. 動態路徑設置 (getContextPath)</a>

```java
//package servlet_examples;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class Hello extends HttpServlet {

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
     req.setCharacterEncoding("Big5");
    res.setContentType("text/html; charset=Big5");
    PrintWriter out = res.getWriter();

    String name = req.getParameter("name");
    out.println("<HTML>");
    out.println("<HEAD><TITLE>Hello, " + name + "</TITLE></HEAD>");
    out.println("<BODY>");
    out.println("Hello, 你好: " + name);

    out.println("<br><img src=\""+req.getContextPath()+"/images/tomcat.gif\">");
    out.println("<br><img src=\""+       "/IBM_9"      +"/images/tomcat.gif\">");
    out.println("<br><img src=\"          /IBM_9         /images/tomcat.gif\">");
    out.println("<br><img src=\"/IBM_9/images/tomcat.gif\">");
    out.println("<br><img src='/IBM_9/images/tomcat.gif'>");

    out.println("</BODY></HTML>");
  }

  public String getServletInfo() {
    return "A servlet that knows the name of the person to whom it's" +
           "saying hello";
  }
}
```

```html
<html>
  <head>
    <title>Hello, peter1吳永志</title>
  </head>
  <body>
    Hello, 你好: peter1吳永志<br />
    <img src="/IBM_9/images/tomcat.gif" /><br />
    <img src="/IBM_9/images/tomcat.gif" /><br />
    <img src="          /IBM_9         /images/tomcat.gif" /><br />
    <img src="/IBM_9/images/tomcat.gif" /><br />
    <img src="/IBM_9/images/tomcat.gif" />
  </body>
</html>
```

# <a id='s6' class='md-title' href='#top'>6. 18 個瀏覽器請求測試</a>

- 步驟 1: 執行測試程式

```cs
檔案路徑: "/SL314/src/PathServlet.java"
```

```java
/*
    測試:   http://localhost:8081/SL314/PathServlet/1.txt?name1=peter1&name2=peter2
    應注意     (※1)注意當有用到【額外路徑資訊】時必須使用【前置路徑對應】的設定
    同時注意(※2)web.xml內的<url-pattern>是<url-pattern>/PathServlet/*</url-pattern>
*/

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class PathServlet extends HttpServlet {
  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {

      res.setContentType("text/plain; charset=Big5");
      PrintWriter out = res.getWriter();

      out.println("==================================context物件 - 路徑資訊及檔案服務==================================");

      out.println("req.getScheme()= "+req.getScheme());
      out.println("req.getServerName()= "+req.getServerName());
      out.println("req.getServerPort()= "+req.getServerPort());
      out.println("req.getContextPath()= "+req.getContextPath());
      out.println("req.getServletPath()= "+req.getServletPath());
      out.println("req.getPathInfo()= "+req.getPathInfo() );
      out.println("req.getPathTranslated()= "+req.getPathTranslated());
      out.println("req.getQueryString()= "+req.getQueryString());

      out.println();
      out.println("req.getRequestURI()= "+req.getRequestURI());
      out.println("【相當於req.getContextPath() + req.getServletPath() + req.getPathInfo()】");

      out.println();
      out.println("req.getMethod()= "+req.getMethod());
      out.println("req.getProtocol()= "+req.getProtocol());

      out.println();
      out.println("req.getHeader(\"Content-Type\")= "+req.getHeader("Content-Type"));
      out.println("req.getContentType()= "+req.getContentType());
      out.println("req.getContentLength()= "+req.getContentLength());

      out.println();
      out.println("req.getRequestURL()= "+req.getRequestURL());
      out.println("【StringBuffer】");
      out.println();

      out.println("==================================context物件 - 路徑資訊及檔案服務==================================");

      out.println("※ getServletContext().getRealPath(\"/xxx.gif\")= "+getServletContext().getRealPath("/xxx.gif"));

      out.println();
      out.println("※ ServletContext context = getServletContext();");
      // 若無此類型副檔名，則顯示為 null
      ServletContext context = getServletContext();
      out.println("context.getMimeType(\"/xxx.gif\")= "+context.getMimeType("/xxx.gif"));
      out.println("context.getMimeType(\"/xxx.jpg\")= "+context.getMimeType("/xxx.jpg"));
      out.println("context.getMimeType(\"/xxx.pdf\")= "+context.getMimeType("/xxx.pdf"));
      out.println("context.getMimeType(\"/xxx.doc\")= "+context.getMimeType("/xxx.doc"));
      out.println("context.getMimeType(\"/xxx.mp3\")= "+context.getMimeType("/xxx.mp3"));
      out.println("context.getMimeType(\"/xxx.avi\")= "+context.getMimeType("/xxx.avi"));
      out.println("========================================================");

    }
    public void doPost(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
      doGet(req,res);
    }
}
```

- 步驟 2: 修改路徑

```cs
"http://localhost:8081/SL314/PathServlet/1111111111111111111111111111111111111111111111111111111111111111111111111.txt"
```

- 步驟 3: 顯示結果

```cs
==================================context物件 - 路徑資訊及檔案服務==================================
req.getScheme()= http
req.getServerName()= localhost
req.getServerPort()= 8081
req.getContextPath()= /SL314
req.getServletPath()= /PathServlet
req.getPathInfo()= /1111111111111111111111111111111111111111111111111111111111111111111111111.txt
req.getPathTranslated()= C:\EA102_WebApp\eclipse_WTP_workspace1\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\SL314\1111111111111111111111111111111111111111111111111111111111111111111111111.txt
req.getQueryString()= null

req.getRequestURI()= /SL314/PathServlet/1111111111111111111111111111111111111111111111111111111111111111111111111.txt
【相當於req.getContextPath() + req.getServletPath() + req.getPathInfo()】

req.getMethod()= GET
req.getProtocol()= HTTP/1.1

req.getHeader("Content-Type")= null
req.getContentType()= null
req.getContentLength()= -1

req.getRequestURL()= http://localhost:8081/SL314/PathServlet/1111111111111111111111111111111111111111111111111111111111111111111111111.txt
【StringBuffer】

==================================context物件 - 路徑資訊及檔案服務==================================
※ getServletContext().getRealPath("/xxx.gif")= C:\EA102_WebApp\eclipse_WTP_workspace1\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\SL314\xxx.gif

※ ServletContext context = getServletContext();
context.getMimeType("/xxx.gif")= image/gif
context.getMimeType("/xxx.jpg")= image/jpeg
context.getMimeType("/xxx.pdf")= application/pdf
context.getMimeType("/xxx.doc")= application/msword
context.getMimeType("/xxx.mp3")= audio/mpeg
context.getMimeType("/xxx.avi")= video/x-msvideo
========================================================
```

- 步驟 4: PathServlet.java 放入路徑

```cs
檔案路徑: "C:\EA102_WebApp\apache-tomcat-9.0.35\webapps\IBM_9\WEB-INF\classes"
```

- 步驟 5: 修改 web.xml，添加 PathServlet 設置

```cs
檔案路徑: "C:\EA102_WebApp\apache-tomcat-9.0.35\webapps\IBM_9\WEB-INF\web.xml"
```

```xml
<!--注意當有用到【額外路徑資訊】時必須使用【前置路徑對應】的設定  -->
<!-- 明確/前置/名稱對應 -->
<servlet>
  <servlet-name>PathServlet</servlet-name>
  <servlet-class>PathServlet</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>PathServlet</servlet-name>
  <url-pattern>/PathServlet/*</url-pattern>
</servlet-mapping>
```

- 表示路徑後方輸入任何什麼字，使用 getPathInfo 都可抓取

```cs
==================================context物件 - 路徑資訊及檔案服務==================================
req.getScheme()= http
req.getServerName()= localhost
req.getServerPort()= 8081
req.getContextPath()= /IBM_9
req.getServletPath()= /PathServlet
req.getPathInfo()= /1111111111111111111111111111111111111111111111111111111111111111111111111.txt
req.getPathTranslated()= C:\EA102_WebApp\apache-tomcat-9.0.35\webapps\IBM_9\1111111111111111111111111111111111111111111111111111111111111111111111111.txt
req.getQueryString()= null

req.getRequestURI()= /IBM_9/PathServlet/1111111111111111111111111111111111111111111111111111111111111111111111111.txt
【相當於req.getContextPath() + req.getServletPath() + req.getPathInfo()】

req.getMethod()= GET
req.getProtocol()= HTTP/1.1

req.getHeader("Content-Type")= null
req.getContentType()= null
req.getContentLength()= -1

req.getRequestURL()= http://localhost:8081/IBM_9/PathServlet/1111111111111111111111111111111111111111111111111111111111111111111111111.txt
【StringBuffer】

==================================context物件 - 路徑資訊及檔案服務==================================
※ getServletContext().getRealPath("/xxx.gif")= C:\EA102_WebApp\apache-tomcat-9.0.35\webapps\IBM_9\xxx.gif

※ ServletContext context = getServletContext();
context.getMimeType("/xxx.gif")= image/gif
context.getMimeType("/xxx.jpg")= image/jpeg
context.getMimeType("/xxx.pdf")= application/pdf
context.getMimeType("/xxx.doc")= application/msword
context.getMimeType("/xxx.mp3")= audio/mpeg
context.getMimeType("/xxx.avi")= video/x-msvideo
========================================================
```

# <a id='s7' class='md-title' href='#top'>7. 取得檔案路徑與檔案型態練習</a>

```cs
圖片檔案不存在時，google瀏覽器不會提醒 File not found(IE會)
但一般搜尋時檔案一定在，所以不處理
```

- 執行程式

```cs
範例程式: "/SL314/src/servlet_examples/ViewFile.java"
測試用檔案路徑: "/SL314/WebContent/images"
```

```java
/*
   測試:   http://localhost:8081/SL314/ViewFile/images/tomcat.gif
   應注意   (※1)注意當有用到【額外路徑資訊】時必須使用【前置路徑對應】的設定
   同時注意(※2)web.xml內的<url-pattern>是<url-pattern>/ViewFile/*</url-pattern>
*/

package servlet_examples;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class ViewFile extends HttpServlet {

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {

    // Use a ServletOutputStream because we may pass binary information
    ServletOutputStream out = res.getOutputStream();

    // Get the file to view
    String file = req.getPathTranslated();
    System.out.println("file="+file);

    // No file, nothing to view
    if (file == null) {
      out.println("No file to view");
      return;
    }

    // Get and set the type of the file
    String contentType = getServletContext().getMimeType(file);
    res.setContentType(contentType);
    System.out.println("contentType="+contentType);

    // Return the file
    FileInputStream in = null;
    try {
      in = new FileInputStream(file);
      byte[] buf = new byte[in.available()]; // buffer
      in.read(buf);
      out.write(buf);
    } catch (FileNotFoundException e) {
      out.println("File not found");
    } catch (IOException e) {
      out.println("Problem sending file: " + e.getMessage());
    } finally {
      if (in != null)
        in.close();
    }
  }
}
```

- 測試檔案

```cs
1. "localhost:8081/SL314/ViewFile/images/tomcat.gif"
```

```cs
file=C:\EA102_WebApp\eclipse_WTP_workspace1\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\SL314\images\tomcat.gif
contentType=image/gif
```

---

```cs
2. "localhost:8081/SL314/ViewFile/images/1.txt"
```

```cs
file=C:\EA102_WebApp\eclipse_WTP_workspace1\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\SL314\images\1.txt
contentType=text/plain
```

---

```cs
3. "localhost:8081/SL314/ViewFile/images/1.pdf"
```

```cs
file=C:\EA102_WebApp\eclipse_WTP_workspace1\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\SL314\images\1.pdf
contentType=application/pdf
```
