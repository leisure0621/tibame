<h1 id="top">目錄</h1>

- [1. Initial & Destory 協同運作](#s1)
- [2. destroy 簡易範例](#s2)
- [3. destory 優化範例](#s3)

---

# <a id='s1' class='md-title' href='#top'>1. Initial & Destory 協同運作</a>

- **目的**: 讓狀態的保存能夠跨越 Servlet 的 <u>存活期</u>
- **模式說明**:
  - 讓 Servlet 有能力在 **<span style='color:red;'>destroy()</span>** 裡儲存自身狀態，然後供下次 **<span style='color:red;'>init()</span>** 被起動時可以取回原狀態
- **注意事項**:
  - 儲存狀態，可用資料留檔案儲存、物件序列化 (serialization)寫入檔案或運用資料庫儲存，視需要而定
  - 注意假如伺服器因 **<span style='color:red;'>當機</span>** 而停止，則 [destroy()](./../03.環境準備/01.設定Tomcat.md#s2) 將 **<span style='color:red;'>不會</span>** 被呼叫

# <a id='s2' class='md-title' href='#top'>2. destroy 簡易範例</a>

- 在此範例中:
  - 步驟一: 執行後先做 init()
  - 步驟二: 接著進行 doGet()
  - 步驟三: shutdown 時，執行 destroy()
- 此時若在 destroy() 中撰寫資料寫出的動作，再由 init() 中寫入讀檔的資料，這樣就能繼續上次的數據

```java
package servlet_examples;

import java.io.*;
import javax.servlet.*;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;


@WebServlet("/HelloWorld_destroy")
public class HelloWorld_destroy extends HttpServlet {
  private static final long serialVersionUID = 1L;

  int count = 0;
  // 程式剛執行時
  public void init() throws ServletException {
    System.out.println("Test from init...HelloWorld_destroy");
  }
  public void doGet(HttpServletRequest req, HttpServletResponse res)
                          throws ServletException, IOException {

    res.setContentType("text/plain; charset=UTF-8");
    PrintWriter out = res.getWriter();
    // count資料會存在記憶體中
    out.println("Hello World World , 世界你好 !"+ (++count));
  }
  public void destroy() {
    System.out.println("count="+count);
  }
}
```

# <a id='s3' class='md-title' href='#top'>3. destory 優化範例</a>

- **參考資料**:

```cs
檔案路徑: "SL314_Servlet4課程分享\SL314_第一次分享\03_Servlet_範例及資源_for_Eclipse_WTP\SL314.war"
```

- **案例程式**:
  - 可將在 destory() 時將數據讀出，並在 init() 時讀入

```java
package servlet_examples;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class InitDestroyCounter extends HttpServlet {

  int count;

  public void destroy() {
    super.destroy();  // entirely optional
    saveState();
  }
  public void doGet(HttpServletRequest req, HttpServletResponse res)
                              throws ServletException, IOException {
    res.setContentType("text/plain");
    PrintWriter out = res.getWriter();
    count++;
    out.println("Since the beginning, this servlet has been accessed " +
                count + " times.");
  }
  public void init() throws ServletException {
    // Try to load the initial count from our saved persistent state
    FileReader fileReader = null;
    BufferedReader bufferedReader = null;
    try {
      fileReader = new FileReader("InitDestroyCounter.initial");
      bufferedReader = new BufferedReader(fileReader);
      String initial = bufferedReader.readLine();
      count = Integer.parseInt(initial);
      return;
    }
    catch (FileNotFoundException ignored) { }  // no saved state
    catch (IOException ignored) { }            // problem during read
    catch (NumberFormatException ignored) { }  // corrupt saved state
    finally {
      // Make sure to close the file
      try {
        if (bufferedReader != null) {
          bufferedReader.close();
        }
      }
      catch (IOException ignored) { }
    }

    // No luck with the saved state, check for an init parameter
    String initial = getInitParameter("initial");
    try {
      count = Integer.parseInt(initial);
      return;
    }
    catch (NumberFormatException ignored) { }  // null or non-integer value

    // Default to an initial count of "0"
    count = 0;
  }
  public void saveState() {
    // Try to save the accumulated count
    FileWriter fileWriter = null;
    PrintWriter printWriter = null;
    try {
      fileWriter = new FileWriter("InitDestroyCounter.initial");
      printWriter = new PrintWriter(fileWriter);
      printWriter.println(count);
      return;
    }
    catch (IOException e) {  // problem during write
      // Log the exception. See Chapter 5.
    }
    finally {
      // Make sure to close the file
      if (printWriter != null) {
        printWriter.close();
      }
    }
  }
}
```
