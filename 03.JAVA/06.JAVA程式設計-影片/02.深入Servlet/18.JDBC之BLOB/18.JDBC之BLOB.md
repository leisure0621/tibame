<h1 id="top">目錄</h1>

- [1. JDBC BLOB](#s1)
- [2. 上傳圖片](#s2)
- [3. 顯示圖片](#s3)

---

# <a id='s1' class='md-title' href='#top'>1. JDBC BLOB</a>

- **從資料庫讀取<span style='color:blue;'>二位元資料</span> (binary data)**

  - java.sql.**<span style='color:blue;'>ResultSet</span>** 介面
    - 可由 java.sql.**<span style='color:blue;'>ResultSet</span>** 介面之 **<span style='color:blue;'>getBinaryStream()</span>** 方法傳回之 java.io.**<span style='color:blue;'>InputStream</span>** 輸入資料流物件，以取得從資料庫讀取出來的二位元資料

- **註: JDBC 資料流觀念，詳見『JDBC』課程**

- **<span style='color:blue;'>送出二位元資料</span> (binary data) 之輸出資料流**

```java
res.setContentType("image/gif");
ServletOutputStream out = res.getOutputStream();
```

- **註: 以上詳見本課程『第 5 單元-傳送 HTML 資訊』**

- **範例:** **DB_Upload.html + DB_UploadTest_Servlet3.java + <span style='color:red;'>DB</span>Gig<span style='color:red;'>Reader.java</span>**

# <a id='s2' class='md-title' href='#top'>2. 上傳圖片</a>

- 可另開此連結 [參考此檔](./doc/WebApp_ch07_DataBase.war)，下載後進行資料庫表創建與 war 匯入

```cs
"/WebApp_ch07_DataBase/src/DB_UploadTest_Servlet3.java"
```

```java
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.*;
import javax.servlet.annotation.WebServlet;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.http.Part;

@WebServlet("/DB_UploadTest_Servlet3.do")
@MultipartConfig(fileSizeThreshold = 1024 * 1024, maxFileSize = 5 * 1024 * 1024, maxRequestSize = 5 * 5 * 1024 * 1024)
// 當數據量大於fileSizeThreshold值時，內容將被寫入磁碟
// 上傳過程中無論是單個文件超過maxFileSize值，或者上傳的總量大於maxRequestSize 值都會拋出
// IllegalStateException 異常
public class DB_UploadTest_Servlet3 extends HttpServlet {

//	String saveDirectory = "/images_uploaded"; // 上傳檔案的目地目錄;
                        // 將由底下的第27行用 java.io.File 於 ContextPath 之下, 自動建立目地目錄

  public void doPost(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    req.setCharacterEncoding("UTF-8"); // 處理中文檔名
    res.setContentType("text/html; charset=UTF-8");
    PrintWriter out = res.getWriter();
    String empno = req.getParameter("empno");

//		System.out.println(getServletContext().getRealPath(saveDirectory)); // 測試用
//		File fsaveDirectory = new File(getServletContext().getRealPath(saveDirectory));
//		if (!fsaveDirectory.exists())
//			fsaveDirectory.mkdirs(); // 於 ContextPath 之下,自動建立目地目錄

    Collection<Part> parts = req.getParts(); // Servlet3.0新增了Part介面，讓我們方便的進行檔案上傳處理
    out.write("<h2> Total parts : " + parts.size() + "</h2>");

    for (Part part : parts) {
      if (getFileNameFromPart(part) != null && part.getContentType()!=null) {
        out.println("<PRE>");
        String name = part.getName();
        String filename = getFileNameFromPart(part);
        String ContentType = part.getContentType();
        long size = part.getSize();
//				File f = new File(fsaveDirectory, filename);

        out.println("name: " + name);
        out.println("filename: " + filename);
        out.println("ContentType: " + ContentType);
        out.println("size: " + size);
//				out.println("File: " + f);

        // 利用File物件,寫入目地目錄,上傳成功
//				part.write(f.toString());

        // 額外測試 InputStream
        InputStream fin = part.getInputStream();
        out.println("InputStream: " + fin);
        PhotoWrite.insertBLOB(fin,filename, empno); //以InputStream直接送進資料庫BLOB欄位
        fin.close();

        out.println();
        out.println("</PRE>");
      }
    }
  }

  // 取出上傳的檔案名稱 (因為API未提供method,所以必須自行撰寫)
  public String getFileNameFromPart(Part part) {
    String header = part.getHeader("content-disposition");
    System.out.println("header=" + header); // 測試用
    String filename = new File(header.substring(header.lastIndexOf("=") + 2, header.length() - 1)).getName();
    System.out.println("filename=" + filename); // 測試用
    if (filename.length() == 0) {
      return null;
    }
    return filename;
  }
}
```

```cs
"/WebApp_ch07_DataBase/src/PhotoWrite.java"
```

```java
import java.sql.*;
import javax.sql.*;
import java.io.*;
import javax.naming.*;

public class PhotoWrite {

  public static void insertBLOB(InputStream fin, String fileName, String empno) {
    Connection con = null;
    PreparedStatement pstmt = null;

    try {
      Context ctx = new javax.naming.InitialContext();
      DataSource ds = (DataSource) ctx.lookup("java:comp/env/jdbc/TestDB2");
      con = ds.getConnection();

      int dotPos = fileName.indexOf('.');
      String picFormat = fileName.substring(dotPos + 1);

      pstmt = con.prepareStatement("update EMP2 set picture=?, picFormat=? where empno=?");
      pstmt.setBinaryStream(1, fin); // JDK6
      pstmt.setString(2, picFormat);
      pstmt.setString(3, empno);
      int rowsUpdated = pstmt.executeUpdate();

      System.out.print("Changed " + rowsUpdated);

      if (1 == rowsUpdated)
        System.out.println(" row.");
      else
        System.out.println(" rows.");
      fin.close();
      pstmt.close();

    } catch (Exception e) {
      e.printStackTrace();
    } finally {
      try {
        con.close();
      } catch (SQLException e) {
      }
    }
  }
}
```

```cs
"/WebApp_ch07_DataBase/WebContent/DB_Upload.html"
```

```html
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Upload.html</title>
  </head>
  <body>
    <form
      action="DB_UploadTest_Servlet3.do"
      method="post"
      enctype="multipart/form-data"
    >
      empno:
      <input type="text" name="empno" /> <br />
      picture:
      <input type="file" name="upfile" /> <br />
      <input type="submit" value="送出上傳" />
    </form>
  </body>
</html>
```

# <a id='s3' class='md-title' href='#top'>3. 顯示圖片</a>

- 可另開此連結 [參考此檔](./doc/WebApp_ch07_DataBase.war)，下載後進行資料庫表創建與 war 匯入

```cs
"/WebApp_ch07_DataBase/src/servlet_examples/DBGifReader.java"
```

```java
package servlet_examples;

import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;
import javax.naming.Context;
import javax.sql.DataSource;

@WebServlet("/DBGifReader")
public class DBGifReader extends HttpServlet {
  private static final long serialVersionUID = 1L;

  Connection con;

  public void doGet(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    req.setCharacterEncoding("Big5");
    res.setContentType("image/gif");
    ServletOutputStream out = res.getOutputStream();

    try {

      Statement stmt = con.createStatement();
      String empno = req.getParameter("empno");
      ResultSet rs = stmt.executeQuery("select picture from EMP2 where empno = '"	+ empno + "'");

      if (rs.next()) {
        BufferedInputStream in = new BufferedInputStream(
            rs.getBinaryStream("picture"));
        byte[] buf = new byte[4 * 1024]; // 4K buffer
        int len;
        while ((len = in.read(buf)) != -1) {
          out.write(buf, 0, len);
        }
        in.close();
      } else {
        res.sendError(HttpServletResponse.SC_NOT_FOUND);
      }
      rs.close();
      stmt.close();
    } catch (Exception e) {
      System.out.println(e);
    }
  }

  public void init() throws ServletException {
    try {
      Context ctx = new javax.naming.InitialContext();
      DataSource ds = (DataSource) ctx
          .lookup("java:comp/env/jdbc/TestDB2");
      con = ds.getConnection();
    } catch (Exception e) {
      System.out.println(e.getMessage());
    }
  }

  public void destroy() {
    try {
      if (con != null)
        con.close();
    } catch (SQLException e) {
      System.out.println(e);
    }
  }

}
```

```cs
"/WebApp_ch07_DataBase/WebContent/ShowImage.html"
```

```html
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=BIG5" />
    <title>form.html</title>
  </head>
  <body>
    <img src="DBGifReader?empno=7001" />
    <img src="DBGifReader?empno=7002" />
    <img src="DBGifReader?empno=7003" />
  </body>
</html>
```

---

參考鏈接:

- [Mysql 中的 clob 和 blob](https://blog.csdn.net/liyazhen2011/article/details/89947141)
