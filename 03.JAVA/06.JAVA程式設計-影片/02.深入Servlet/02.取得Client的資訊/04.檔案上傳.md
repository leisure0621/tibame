<h1 id="top">目錄</h1>

- [1. 檔案上傳 - 說明](#s1)
- [2. 檔案上傳 - HTML 格式](#s2)
- [3. 完整上傳範例](#s3)

---

# <a id='s1' class='md-title' href='#top'>1. 檔案上傳 - 說明</a>

- Servlet 3.0 新增了 Part 介面，讓我們方便的進行檔案上傳
  - **Collection&lt;<span style='color:#d23200;'>Part</span>&gt; <span style='color:red;'>req.</span><span style='color:blue;'>getParts()</span>**
    - 如果有多個檔案要上傳，可以使用 getParts() 方法，會傳回一個 Collection，Collection 中事每個上傳檔案的 Part 物件
  - **Part <span style='color:red;'>req.</span><span style='color:blue;'>getParts(String name)</span>**
    - getPart("name"); 方法接受一個字串，代表著檔案上傳欄位的 name 屬性，會傳回一個上傳檔案的 Part 物件

> 註:
> <span style='color:#d23200;'>Part</span> 物件的 <span style='color:blue;'>getInputStream()</span> 方法，傳回<u> java.io.InputStream </u>(Get the content of this part as an InputStream)
> 這將讓上傳到伺服器的文件資料，可以很容易的寫入磁碟成為檔案文件，或以 BinaryStream 的方式送進資料庫成為表格文件

# <a id='s2' class='md-title' href='#top'>2. 檔案上傳 - HTML 格式</a>

- 用戶端之 HTML 表單(form)必須以下列格式完成

```html
<form action="執行之Servlet或JSP" method="post" encype="multipart/form-data">
  <input type="file" name="upflie" />
  <input type="submit" value="上傳" />
</form>
```

> 範例: Upload.html + UploadTest_Servlet3.java

# <a id='s3' class='md-title' href='#top'>3. 完整上傳範例</a>

- **上傳寫法**

```cs
"/WebApp_ch04/src/UploadTest_Servlet3.java"
```

```java
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.*;
import javax.servlet.annotation.WebServlet;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.http.Part;

@WebServlet("/uploadServlet3.do")
@MultipartConfig(fileSizeThreshold = 1024 * 1024, maxFileSize = 5 * 1024 * 1024, maxRequestSize = 5 * 5 * 1024 * 1024)
// 當數據量大於fileSizeThreshold值時，內容將被寫入磁碟
// 上傳過程中無論是單個文件超過maxFileSize值，或者上傳的總量大於maxRequestSize 值都會拋出
// IllegalStateException 異常
public class UploadTest_Servlet3 extends HttpServlet {

  String saveDirectory = "/images_uploaded"; // 上傳檔案的目地目錄;
                        // 將由底下的第27行用 java.io.File 於 ContextPath 之下, 自動建立目地目錄

  public void doPost(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    req.setCharacterEncoding("UTF-8"); // 處理中文檔名
    res.setContentType("text/html; charset=UTF-8");
    PrintWriter out = res.getWriter();

    System.out.println(getServletContext().getRealPath(saveDirectory)); // 測試用
    // 將會在localhost中創建指定目錄 "\images_uploaded" ， 並將圖片放入此目錄中
    // eclipse 目錄路徑: \.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\WebApp_ch04\images_uploaded
    // Tomcat 目錄路徑: Tomcat 根目錄下 > WebApps > 專案名稱下
    File fsaveDirectory = new File(getServletContext().getRealPath(saveDirectory));
    if (!fsaveDirectory.exists())
      fsaveDirectory.mkdirs(); // 於 ContextPath 之下,自動建立目地目錄

    Collection<Part> parts = req.getParts(); // Servlet3.0新增了Part介面，讓我們方便的進行檔案上傳處理
    out.write("<h2> Total parts : " + parts.size() + "</h2>");

    for (Part part : parts) {
      if (getFileNameFromPart(part) != null && part.getContentType()!=null) {
        out.println("<PRE>");
        String name = part.getName();
        String filename = getFileNameFromPart(part);
        String ContentType = part.getContentType();
        long size = part.getSize();
        File f = new File(fsaveDirectory, filename);

        out.println("name: " + name);
        out.println("filename: " + filename);
        out.println("ContentType: " + ContentType);
        out.println("size: " + size);
        out.println("File: " + f);

        // 利用File物件,寫入目地目錄,上傳成功
        part.write(f.toString());

        // 額外測試 InputStream
        InputStream fin = part.getInputStream();
        out.println("InputStream: " + fin);
        fin.close();

        out.println();
        out.println("</PRE>");
      }
    }
  }

  // 取出上傳的檔案名稱 (因為API未提供method,所以必須自行撰寫)
  public String getFileNameFromPart(Part part) {
    String header = part.getHeader("content-disposition");
    System.out.println("header=" + header); // 測試用
    String filename = new File(header.substring(header.lastIndexOf("=") + 2, header.length() - 1)).getName();
    System.out.println("filename=" + filename); // 測試用
    if (filename.length() == 0) {
      return null;
    }
    return filename;
  }
}
```

- **jsp 寫法**

```html
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Upload.html</title>
  </head>
  <body>
    <form
      action="uploadServlet3.do"
      method="post"
      enctype="multipart/form-data"
    >
      <input type="file" name="upfile1" />
      <br />
      <input type="file" name="upfile2" />
      <input type="submit" value="ä¸å³" />
    </form>
  </body>
</html>
```
