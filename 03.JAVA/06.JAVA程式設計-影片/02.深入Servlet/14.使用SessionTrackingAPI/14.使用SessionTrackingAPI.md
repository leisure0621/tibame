<h1 id="top">目錄</h1>

- [1. HttpSession 介面目的](#s1)
- [2. 如何取得 HttpSession 物件](#s2)
- [3. 伺服器實作 Session Tracking 的原理](#s3)
- [4. HttpSession 介面之屬性 (Attribute) method](#s4)
- [5. 程式片段 (取得「session」擁有之所有屬性名稱、值)](#s5)
- [6. 測試範例 A](#s6)
- [7. 測試範例 B](#s7)
- [8. HttpSession 介面其他 Method](#s8)
- [9. 設定 Session 的有效時間](#s9)

---

# <a id='s1' class='md-title' href='#top'>1. HttpSession 介面目的</a>

- 伺服器利用配發一個 HttpSession 物件，讓 Servlet 可以用來儲存獲取得該使用者的相關資訊，以達到 Session Tracking 的目的
- 可將任和物件存入 HttpSession 物件內

# <a id='s2' class='md-title' href='#top'>2. 如何取得 HttpSession 物件</a>

- **HttpSession <span style='color:blue;'>session</span> = <span style='color:red;'>req</span>.<span style='color:blue;'>getsession();</span>**
- <span style='color:red;'>req</span> 為 HttpServletRequest 物件，此代表發出<span style='color:red;'>該請求</span>的使用者<span style='color:red;'>目前所處的 session</span>
- Session 與 cookie 一樣只有<span style='color:red;'>特定存活時間</span>，非永生不滅

# <a id='s3' class='md-title' href='#top'>3. 伺服器實作 Session Tracking 的原理</a>

- 伺服器介由 (以 <span style='color:#9C27B0;'>cookie</span> 或 <span style='color:#9C27B0;'>URL Rewriting</span> 的方式) 傳送一個 session 的 ID 值至用戶端，在做為用戶端下一次請求時，取出比對之用
- String ID = **<span style='color:red;'>sessiion</span>**.**<span style='color:blue;'>getId();</span>**
  - 以此方法查看 session 的 ID 值
  - 其值可能形為 **<span style='color:blue;'>253309095B6B2786A63BC9BCA173BA69</span>** 之亂數形態

# <a id='s4' class='md-title' href='#top'>4. HttpSession 介面之屬性 (Attribute) method</a>

- **void <span style='color:red;'>session</span>.<span style='color:blue;'>setAttribute(String name, Object value)</span>**
  - 將指定的物件存入 session 中
- **Object <span style='color:red;'>session</span>.<span style='color:blue;'>getAttribute(String name)</span>**
  - 從 session 中取出物件
- **void <span style='color:red;'>session</span>.<span style='color:blue;'>removeAttribute(String name)</span>**
  - 從 session 中移除物件
- **Enumeration <span style='color:red;'>session</span>.<span style='color:blue;'>getAttributeNames()</span>**
  - 將目前 session 中的所有屬性名稱以 Enumeration 型態傳回

> <span style='color:red;'>特別注意:</span> request，<span style='color:red;'>session</span>，ServetContext (即 JSP 之 application) 等物皆有和屬性 (Attribute) 有關的如上 4 個 methods，應分辨其間之不同處！

# <a id='s5' class='md-title' href='#top'>5. 程式片段 (取得「session」擁有之所有屬性名稱、值)</a>

```java
HttpSession session = req.getSession();

Enumeration enum = session.getAttributeNames();
while(enum.hasMoreElements()){
  String name = (String) enum.nextElement();
  out.println(name + ":" + context.getAttribute(name));
}
```

# <a id='s6' class='md-title' href='#top'>6. 測試範例 A</a>

- 範例 A: Session_Set.java; session_Get.java (行為測試)
  - 可另開此連結 [參考此檔](./doc/WebApp_ch06.war)

```cs
參考範例: "/WebApp_ch06/WebContent/WEB-INF/web.xml"
```

```xml
<servlet>
  <servlet-name>Session_Set</servlet-name>
  <servlet-class>Session_Set</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>Session_Set</servlet-name>
  <url-pattern>/Session_Set</url-pattern>
</servlet-mapping>

<servlet>
  <servlet-name>Session_Get</servlet-name>
  <servlet-class>Session_Get</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>Session_Get</servlet-name>
  <url-pattern>/Session_Get</url-pattern>
</servlet-mapping>
```

```cs
參考範例: "/WebApp_ch06/src/Session_Get.java"
```

```java
import java.io.*;

import javax.servlet.*;
import javax.servlet.http.*;

public class Session_Get extends HttpServlet {


  public void doGet(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    res.setContentType("text/html; charset=UTF-8");
    PrintWriter out = res.getWriter();

    HttpSession session = req.getSession();
    Object myName2 = session.getAttribute("myName2");
    out.println(myName2);

    String ID = session.getId();
    out.println("<br>");
      out.println("ID="+ID);
  }
}
```

```cs
參考範例: "/WebApp_ch06/src/Session_Set.java"
```

```java
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class Session_Set extends HttpServlet {


  public void doGet(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    res.setContentType("text/html; charset=UTF-8");
    PrintWriter out = res.getWriter();

    HttpSession session = req.getSession();
        session.setAttribute("myName2","世界你好2");

        String ID = session.getId();
        out.println("ID="+ID);

  }
}
```

> 第一步: 初次執行 Session_Get 會發現頁面上 out.println(myName2) 出來的結果會是 null 這可以反映出沒設定 session 時的值是空值。ID 則是 Session ID
> 第二步: 執行 Session_Set 設至參數後在執行 Session_Get，ID 會延續，且同瀏覽器時 Session 值會延續，不同瀏覽器則不會。因為 ID 不同。
> 第三步: 關閉所有瀏覽器。而瀏覽器若全關閉則表示 session 都關閉了，此時若 get 一樣得不到值。但其實若沒改變 session 預設的時間，則 30 分鐘不動 session 一樣會失效

# <a id='s7' class='md-title' href='#top'>7. 測試範例 B</a>

- 範例 B: SessionTracker.java (用 Session Tracking 計次)
  - 可另開此連結 [參考此檔](./doc/WebApp_ch06.war)

```cs
參考範例: "/WebApp_ch06/WebContent/WEB-INF/web.xml"
```

```xml
<servlet>
  <servlet-name>SessionTracker</servlet-name>
  <servlet-class>servlet_examples.SessionTracker</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>SessionTracker</servlet-name>
  <url-pattern>/SessionTracker</url-pattern>
</servlet-mapping>
```

```java
參考範例: "/WebApp_ch06/src/servlet_examples/SessionTracker.java"
```

```java
package servlet_examples;

import java.io.*;
import java.util.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class SessionTracker extends HttpServlet {

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                              throws ServletException, IOException {
    res.setContentType("text/html");
    PrintWriter out = res.getWriter();

    // Get the current session object, create one if necessary
    HttpSession session = req.getSession();

    // Increment the hit count for this page. The value is saved
    // in this client's session under the name "tracker.count".
    // 先取，在放值
    Integer count = (Integer)session.getAttribute("tracker.count");
    if (count == null)
      count = new Integer(1);
    else
      count = new Integer(count.intValue() + 1);
    session.setAttribute("tracker.count", count);

    out.println("<HTML><HEAD><TITLE>SessionTracker</TITLE></HEAD>");
    out.println("<BODY><H1>Session Tracking Demo</H1>");

    // Display the hit count for this page
    out.println("You've visited this page " + count +
      ((count.intValue() == 1) ? " time." : " times."));

    out.println("<P>");

    out.println("<H2>Here is your session data:</H2>");
    Enumeration en = session.getAttributeNames();
    while (en.hasMoreElements()) {
      String name = (String) en.nextElement();
      out.println(name + ": " + session.getAttribute(name) + "<BR>");
    }
    out.println("</BODY></HTML>");
  }
}
```

# <a id='s8' class='md-title' href='#top'>8. HttpSession 介面其他 Method</a>

- **boolean <span style='color:red;'>session</span>.<span style='color:blue;'>isNew()</span>**
  - 若用戶端尚未加入 session tracking，傳回 true
  - (指當 session 第一次被建立，session ID 剛送給用戶，且用戶端尚未發出第二次請求時，傳回 true)
- **void <span style='color:red;'>session</span>.<span style='color:blue;'>invalidate()</span>**
  - 讓此次的 session 失效，並解除已經連結的所有物件
- **int <span style='color:red;'>session</span>.<span style='color:blue;'>getMaxInactiveInterval()</span>**
  - 查詢 session 最大留存時間
- **void <span style='color:red;'>session</span>.<span style='color:blue;'>setMaxInactiveInterval(int seconds)</span>**
  - 設定最大留存時間
- **long <span style='color:red;'>session</span>.<span style='color:blue;'>getCreationTime()</span>**
  - 傳回 session 建立的時間
- **long <span style='color:red;'>session</span>.<span style='color:blue;'>getLastAccessedTime()</span>**
  - 傳回 session 上次存取的時間
- **String <span style='color:red;'>session</span>.<span style='color:blue;'>getId()</span>**
  - 傳回 Servlet Container 指定的 session ID

# <a id='s9' class='md-title' href='#top'>9. 設定 Session 的有效時間</a>

- **<span style='color:blue;'>等待時限 timeout:</span>** 對於同一個使用者而言，兩次請求 (Request) 之間的時間間格不能超過「等待時限 timeout」，否則 session 將失效
- **<span style='color:blue;'>設定:</span>**
  - 如未自行設定，大部分 server 之 **<span style='color:red;'>預設</span>** 值為 30 分鐘
  - **<span style='color:red;'>個別</span>** session 自己的設定，可採前述之 session.**<span style='color:blue;'>setMaxInactiveInterval(int seconds)</span>** 方法設定
  - **<span style='color:red;'>每個 Web App</span>** 例用 web.xml 檔的設定，將適用其下所有 session
  - 如要 **<span style='color:red;'>手動停止</span>** session，可採前述之 session.**<span style='color:blue;'>invalidate()</span>** 方法，session 會立即失效

```xml
<!-- 所有 session 時間 -->
<web-app>
  <session-config>
    <session-timeout>
    60 <!-- minutes 以分鐘為單位 -->
    </session-timeout>
  </session-config>
</web-app>
```
