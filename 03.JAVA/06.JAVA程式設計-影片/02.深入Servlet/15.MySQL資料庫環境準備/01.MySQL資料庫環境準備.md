<h1 id="top">目錄</h1>

- [1. 資料庫連結](#s1)
- [2. MySQL 資料庫環境準備](#s2)
- [3. MySQL 資料庫 - JDBC 驅動程式](#s3)
- [4. MySQL 資料庫 - 新建測試用的 table](#s4)
- [5. 建立 MySQL 資料表](#s5)
- [6. 資料庫連結 - 基本觀念](#s6)
- [7. 具備 JDBC 能立的 Servlet](#s7)
- [8. 資料庫連線的重覆使用](#s8)

---

# <a id='s1' class='md-title' href='#top'>1. 資料庫連結</a>

- MySQL 資料庫環境準備
- 資料庫連結 - 基本觀念
- 具備基本 JDBC 能立的 Servlet
- 資料庫連線的重覆使用
- Transaction 管理
- Connection pool - 連線池
- JDBC BLOB

# <a id='s2' class='md-title' href='#top'>2. MySQL 資料庫環境準備</a>

- **MySQL 資料庫安裝**

  - **<span style='color:blue;'>MySQL 下載</span>**
    - 官方網址: https://dev.mysql.com/downloads/windows/installer/
  - **<span style='color:blue;'>MySQL 安裝</span>**
    - 執行 **<span style='color:blue;'>mysql-installer-community-5.6.22.0.msi</span>** 檔案，進行安裝 MySQL 資料庫
  - **<span style='color:blue;'>MySQL Workbench 6.x</span>**
    - MySQL 的工作台
  - **<span style='color:blue;'>mysql-connector-java-x.x.xx-bin.jar JDBC 趨動</span>**
    - [官方載點](https://ithelp.ithome.com.tw/articles/10215425)

# <a id='s3' class='md-title' href='#top'>3. MySQL 資料庫 - JDBC 驅動程式</a>

- **<span style='color:blue;'>mysql-connector-java-5.x.xx-bin.jar</span>**
  - 這是 MySQL 資料庫的 JDBC 驅動程式，需下載最新的也可到 [官方載點](https://ithelp.ithome.com.tw/articles/10215425)
    - 下載方式具體可參照 [java，mysql、jdbc](https://ithelp.ithome.com.tw/articles/10215425) 說明
  - 因為本課程的<span style='color:blue;'>第 1 單元(Servlet Web Application 概觀 與 開發環境準備)</span>已經介紹過如何下載此 jar 檔。因此，此 jar 檔也已依當時的說明，已經置於 <u>C:\apache-tomcat-8.x\lib</u> 內

# <a id='s4' class='md-title' href='#top'>4. MySQL 資料庫 - 新建測試用的 table</a>

- **<span style='color:blue;'>dept2 與 emp2</span>**
  - 這是測試用的兩個 table(1 對多)
  - **<span style='color:blue;'>emp2</span>** table 內含 **<span style='color:red;'>BLOB 大型二進位欄位型態</span>**

# <a id='s5' class='md-title' href='#top'>5. 建立 MySQL 資料表</a>

- 可另開此連結 [參考此檔](./doc/WebApp_ch07_DataBase.war)，下載後進行資料庫表創建與 war 匯入
- 執行 SQL 建立表格與資料
  - 不曉得如何操作，可參照 [02.MySQL 安裝詳細教學](./02.MySQL安裝詳細教學.md)

```sql
use db01;

DROP TABLE IF EXISTS EMP2;
DROP TABLE IF EXISTS DEPT2;

CREATE TABLE DEPT2 (
  DEPTNO	INT(2) AUTO_INCREMENT NOT NULL,
  DNAME	VARCHAR(14),
  LOC		VARCHAR(13),
  CONSTRAINT DEPT2_PRIMARY_KEY PRIMARY KEY (DEPTNO)
) AUTO_INCREMENT = 50;

INSERT INTO DEPT2 VALUES (10,'財務部','臺灣台北');
INSERT INTO DEPT2 VALUES (20,'研發部','臺灣新竹');
INSERT INTO DEPT2 VALUES (30,'業務部','美國紐約');
INSERT INTO DEPT2 VALUES (40,'生管部','中國上海');

CREATE TABLE EMP2 (
  EMPNO		INT(4) AUTO_INCREMENT NOT NULL,
  ENAME		VARCHAR(10),
  JOB			VARCHAR(9),
  HIREDATE	DATE,
  SAL			DECIMAL(7,0),
  COMM		DECIMAL(7,0),
  picture     BLOB,
  picFormat   VARCHAR(5),
  DEPTNO		INT(2) NOT NULL,
  CONSTRAINT EMP2_DEPTNO_FK FOREIGN KEY (DEPTNO) REFERENCES DEPT2 (DEPTNO),
  CONSTRAINT EMP2_EMPNO_PK PRIMARY KEY (EMPNO)
) AUTO_INCREMENT = 7015;

INSERT INTO EMP2 VALUES (7001,'KING'  ,'PRESIDENT',STR_TO_DATE('1981-11-17','%Y-%m-%d'),5000.5,0.0,null,null,10);
INSERT INTO EMP2 VALUES (7002,'BLAKE' ,'MANAGER'  ,STR_TO_DATE('1981-05-01','%Y-%m-%d'),2850,0.0,null,null,30);
INSERT INTO EMP2 VALUES (7003,'CLARK' ,'MANAGER'  ,STR_TO_DATE('1981-01-09','%Y-%m-%d'),2450,0.0,null,null,10);
INSERT INTO EMP2 VALUES (7004,'JONES' ,'MANAGER'  ,STR_TO_DATE('1981-04-02','%Y-%m-%d'),2975,0.0,null,null,20);
INSERT INTO EMP2 VALUES (7005,'MARTIN','SALESMAN' ,STR_TO_DATE('1981-09-28','%Y-%m-%d'),1250,1400,null,null,30);
INSERT INTO EMP2 VALUES (7006,'ALLEN' ,'SALESMAN' ,STR_TO_DATE('1981-02-02','%Y-%m-%d'),1600,300,null,null,30);
INSERT INTO EMP2 VALUES (7007,'TURNER','SALESMAN' ,STR_TO_DATE('1981-09-28','%Y-%m-%d'),1500,0,null,null,30);
INSERT INTO EMP2 VALUES (7008,'JAMES' ,'CLERK'    ,STR_TO_DATE('1981-12-03','%Y-%m-%d'), 950,0.0,null,null,30);
INSERT INTO EMP2 VALUES (7009,'WARD'  ,'SALESMAN' ,STR_TO_DATE('1981-02-22','%Y-%m-%d'),1250,500,null,null,30);
INSERT INTO EMP2 VALUES (7010,'FORD'  ,'ANALYST'  ,STR_TO_DATE('1981-12-03','%Y-%m-%d'),3000,0.0,null,null,20);
INSERT INTO EMP2 VALUES (7011,'SMITH' ,'CLERK'    ,STR_TO_DATE('1980-12-17','%Y-%m-%d'), 800,0.0,null,null,20);
INSERT INTO EMP2 VALUES (7012,'SCOTT' ,'ANALYST'  ,STR_TO_DATE('1981-12-09','%Y-%m-%d'),3000,0.0,null,null,20);
INSERT INTO EMP2 VALUES (7013,'ADAMS' ,'CLERK'    ,STR_TO_DATE('1983-01-12','%Y-%m-%d'),1100,0.0,null,null,20);
INSERT INTO EMP2 VALUES (7014,'MILLER','CLERK'    ,STR_TO_DATE('1982-01-23','%Y-%m-%d'),1300,0.0,null,null,10);
```

- 測試初次連線 **(此步驟需要能取得資料，才可繼續以後的範例)**

```cs
範例檔案: "/WebApp_ch07_DataBase/src/servlet_examples/DBEmpLookup1.java"
```

```java
package servlet_examples;

import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;

@WebServlet("/DBEmpLookup1")
public class DBEmpLookup1 extends HttpServlet {
  private static final long serialVersionUID = 1L;

  public void doGet(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    Connection con = null;
    Statement stmt = null;
    ResultSet rs = null;

    res.setContentType("text/html; charset=UTF-8");
    PrintWriter out = res.getWriter();

    try {
      Class.forName("com.mysql.jdbc.Driver");
      // 若連線無法連上則須修改 (添加編碼格式)，並下載 mysql-connector-java-8.0.21.jar 放入 WEB-INF/lib 中
      // con = DriverManager.getConnection("jdbc:mysql://localhost:3306/db01?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UT", "root", "123456");
      con = DriverManager.getConnection("jdbc:mysql://localhost:3306/db01", "root", "123456");
      stmt = con.createStatement();
      rs = stmt.executeQuery("select empno, ename from EMP2");

      out.println("<HTML><HEAD><TITLE>EmpLookup1</TITLE></HEAD>");
      out.println("<BODY>");
      out.println("<UL>");
      while (rs.next()) {
        out.println("<LI>" + rs.getString("empno") + " "+ rs.getString("ename"));
      }
      out.println("</UL>");
      out.println("</BODY></HTML>");
    } catch (ClassNotFoundException e) {
      out.println("Couldn't load database driver: " + e.getMessage());
    } catch (SQLException e) {
      out.println("SQLException caught: " + e.getMessage());
    } finally {
      try {
        if (con != null)
          con.close();
      } catch (SQLException ignored) {
      }
    }
  }
}
```

- 顯示結果

```cs
● 7001 KING
● 7002 BLAKE
● 7003 CLARK
● 7004 JONES
● 7005 MARTIN
● 7006 ALLEN
● 7007 TURNER
● 7008 JAMES
● 7009 WARD
● 7010 FORD
● 7011 SMITH
● 7012 SCOTT
● 7013 ADAMS
● 7014 MILLER
```

# <a id='s6' class='md-title' href='#top'>6. 資料庫連結 - 基本觀念</a>

- **基本觀念**
  - 資料庫是 Web 的原動力。但是，與其互動是要付出代價的，包括 **<span style='color:blue;'>開發上的困難度通常比較高; 甚至造成整體效能的滑落</span>**
  - **<span style='color:red;'>「Servlet 與 JDBC API」</span>** 是一套優雅、絕妙的組合。因為 Servlet 具有無現的生命週期，而 JDBC 又是一個定義嚴謹且能連接各種資料庫的 API。兩者之結合可減少一般開發上的困難度 ; 並且， **<span style='color:blue;'>應妥善利用 Servlet 生命週期特性，可降低因為應用程式與 料庫連接實的整體效能滑落</span>**

# <a id='s7' class='md-title' href='#top'>7. 具備 JDBC 能立的 Servlet</a>

- **結合 Servlet 與 JDBC API**
  - 因為最基本類型的 HTTP servlet，原就可產生一個完全由 HTML 構成的網頁;
  - 因此只要加入 JDBC 的 Class.forName('MyDriver')...等 **<span style='color:red;'>4</span>** 行程式碼，非常輕易就可完成一個具備 JDBC 能立的 Servlet
- **範例**
  - **<span style='color:red;'>DB</span>Emp<span style='color:red;'>Lookup1.java</span>** (具備 JDBC 能立的 Servlet，此為初階範例所以效能不佳)
    - 可另開此連結 [參考此檔](./doc/WebApp_ch07_DataBase.war) (下載並匯入檔案)

# <a id='s8' class='md-title' href='#top'>8. 資料庫連線的重覆使用</a>

- **效能瓶頸的問題**
  - **<span style='color:red;'>Connection con = DriverManager.getConnection(...); 是效能的瓶頸</span>**
    - 在使用 JDBC 一段時間後，將發現最嚴重的效能瓶頸出現在「開使」「開啟」資料庫連線的時候
    - 對 Servlet 來說，如果每次被請求(Request)時都要建立新的資料庫連線(Connection 物件)，然後再撤銷掉，這問題將會比較嚴重
      - <small>con 此連線是個區域變數，每次都要開啟在歸還(就像開一間餐廳，每個送菜的服務生是有人點菜就雇用，送完菜就辭退了一樣)</small>
- **資料庫連現的重覆使用**
  - 如能妥善運用 Servlet 的生命週其特性，讓資料庫的連線能夠重覆使用，將可解決此連線時的瓶頸問題
- **做法**
  - 步驟 1: **<span style='color:red;'>宣告 Connection 物件為實體變數(instance variable)</span>**
    - **private Connection con = null;**
  - 步驟 2: 由 **<span style='color:red;'>init()</span>** 負責 Connection 實體搭建
  - 步驟 3: 由 **<span style='color:red;'>doGet()</span>** or **<span style='color:red;'>doPost()</span>** 負責處裡 SQL 指令(即每次請求都重覆使用該連線)
  - 步驟 4: 由 **<span style='color:red;'>distory()</span>** 負責撤銷該連線
    - Servlet 卸載時伺服器會呼叫此方法，而且只呼叫一次(由伺服器幫忙呼叫此方法撤銷連線)，即在生命週期的最後階段撤銷該連線
- **範例**
  - **DBEmpLookup2\_<span style='color:red;'>Resuse</span>.java** (資料庫連線重覆使用的 Servlet)

```java
package servlet_examples;

import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;

@WebServlet("/DBEmpLookup2_Reuse")
public class DBEmpLookup2_Reuse extends HttpServlet {
  private static final long serialVersionUID = 1L;

  // 1. 宣告為實體變數
  private Connection con = null;

  public void doGet(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    Statement stmt = null;
    ResultSet rs = null;

    res.setContentType("text/html; charset=UTF-8");
    PrintWriter out = res.getWriter();

    try {
      // 3. 處裡SQL指令
      stmt = con.createStatement();
      rs = stmt.executeQuery("select empno, ename from EMP2");

      out.println("<HTML><HEAD><TITLE>EmpLookup1</TITLE></HEAD>");
      out.println("<BODY>");
      out.println("<UL>");
      while (rs.next()) {
        out.println("<LI>" + rs.getString("empno") + " " + rs.getString("ename"));
      }
      out.println("</UL>");
      out.println("</BODY></HTML>");
      rs.close();
      stmt.close();
    } catch (SQLException e) {
      out.println("SQLException caught: " + e.getMessage());
    }
  }

  // 2. init 實體搭建
  public void init() throws ServletException {
    try {
      Class.forName("com.mysql.jdbc.Driver");
      con = DriverManager.getConnection("jdbc:mysql://localhost:3306/db01?useUnicode=true&characterEncoding=utf8", "root", "123456");
    } catch (ClassNotFoundException e) {
      throw new UnavailableException("Couldn't load database driver");
    } catch (SQLException e) {
      throw new UnavailableException("Couldn't get db connection");
    }
  }

  // 4. 撤銷連線
  public void destroy() {
    try {
      if (con != null)
        con.close();
    } catch (SQLException ignored) {
    }
  }

}
```

- **<span style='color:blue;'>優點</span>**
  - <span style='color:blue;'>達成 Persistence (持續性) 之優越性，而且總共只連線資料庫一次</span>
- **<span style='color:red;'>注意 Transaction (交易) 的問題</span>**
  - 佔用一個資料庫連線後，如又極少執行此 Servlet，將造成「佔用浪費」(雖然只有一個連線)
  - 或使用一個連線後，如果執行程式頻率極高，程式內又有使用 Transaction (交易、異動)，可能造成多個執行緒同時共用一個資料庫連線的不正常情況
  - <span style='color:red;'>須注意: 使用 Transaction 時資料庫連線不能共用</span>

---

參考鏈接:

- [MySQL Community Downloads](https://dev.mysql.com/downloads/)
- [mysql-connector-java-5.1.15-bin.jar](https://dev.mysql.com/downloads/connector/j/)
- [JDBC 连接 MySQL：Unknown initial character set index '255' received from server.Initial client character](https://blog.csdn.net/qq1515312832/article/details/85614733)
- [JDBC 连接 MYSQL 数据库失败，Loading class `com.mysql.jdbc.Driver'. This is deprecated.](https://blog.csdn.net/weixin_42323802/article/details/82589743)
- [使用 JDBC 连接 MySql 时出现：The server time zone value '�й���׼ʱ��' is unrecognized or represents more than one time zone. You must configure either the server or JDBC driver (via the serverTimezone configuration](https://www.cnblogs.com/EasonJim/p/6906713.html)
