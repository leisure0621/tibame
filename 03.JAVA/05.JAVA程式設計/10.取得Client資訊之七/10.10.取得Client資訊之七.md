<p><img src="./image/05-10_01_p77.png"></p>

<p><img src="./image/05-10_02_p80.png"></p>

<p><img src="./image/05-10_03_p291.png"></p>

<p><img src="./image/05-10_04_code.png"></p>

- foe each 是為了泛型而生

<p><img src="./image/05-10_05_code.png"></p>

<p><img src="./image/05-10_06_p78.png"></p>

<p><img src="./image/05-10_02_p80.png"></p>

- 可以純粹放
  - 目錄
  - 檔案
  - 目錄+檔案
- part
  - write 寫入硬碟
  - getInputStream 上傳到伺服器

<p><img src="./image/05-10_07.png"></p>

- 沒有寫 write ，則無法將圖片傳上
- 上傳檔名相同的檔案，會覆蓋上傳的同名檔案
- 修改了副檔名(ex. JPG 改 GIF)
  - IE: 仍會抓取真正的檔案型態(JPG)
  - GOOGLE: 會抓取修改後的檔案型態(GIF)

<p><img src="./image/05-10_08_code.png"></p>

- blob 將二位元資料儲存入資料庫，可以上傳多張圖片且不須要保存黨名

  - 且不需要特別保存數據在硬碟，只要存在資料庫(BLOB 一個欄位可以放 4G)
  - 資料庫只釋放參考點，而不是放圖片，實際上二位元資料還是保存在硬碟中，所以資料庫即使存放的檔案大，也不會影響到實際效率

<p><img src="./image/05-10_09_p86.png"></p>

- Statement
- CallableStatement
- preparedStatement
  - 傳檔方法
    - setBinaryStream
      - setBinaryStream(int, InputStream, int) 舊版
      - `part` getInputStream > `preparedStatement` setBinaryStream
      - InputStream
        - 缺點: 有`關檔問題`(串流有關檔問題)，close()
        - 優點: 可直接傳至資料庫
    - setBlob
      - 有`connection 關檔`與介面問題，Blob 靠 connection 來 ctrateBlog() 表示連線不能關
      - ctrateBlog() 這些都屬於佔存資料
    - setBytes
      - 使用 byte 資料傳輸，不需要關 stream，`建議使用`

<p><img src="./image/05-10_10_code.png"></p>

- 設定多少參數，資料庫相應有多少參數

<p><img src="./image/05-10_11_code.png"></p>

<p><img src="./image/05-10_12.png"></p>

<p><img src="./image/05-10_13_p78.png"></p>

<p><img src="./image/05-10_14_code.png"></p>

- 老師寫得比 API 好用

<p><img src="./image/05-10_15_p291.png"></p>

<p><img src="./image/05-10_16.png"></p>

- 上傳三要素，p81、p82

<p><img src="./image/05-10_18_p81.png"></p>

<p><img src="./image/05-10_17_p82.png"></p>

- @MultipartConfig 限制上傳資訊

<p><img src="./image/05-10_19_code.png"></p>

<p><img src="./image/05-10_21_p58.png"></p>

<p><img src="./image/05-10_22_p84.png"></p>

<p><img src="./image/05-10_23_p273.png"></p>

<p><img src="./image/05-10_24_p87.png"></p>

<p><img src="./image/05-10_25_p60.png"></p>

- 背起來

<p><img src="./image/05-10_26_p62.png"></p>

<p><img src="./image/05-10_27_p65.png"></p>

<p><img src="./image/05-10_28_p67.png"></p>

<p><img src="./image/05-10_29_p70.png"></p>

<p><img src="./image/05-10_30_p71.png"></p>

<p><img src="./image/05-10_31_p233.png"></p>

<p><img src="./image/05-10_32_p73.png"></p>

- (10)、(11)、(15)不重要

<p><img src="./image/05-10_33_p76.png"></p>

<p><img src="./image/05-10_34_p77.png"></p>

<p><img src="./image/05-10_35_p78.png"></p>

- 作業

<p><img src="./image/05-10_36_p85.png"></p>

<p><img src="./image/05-10_37_p87.png"></p>

<p><img src="./image/05-10_38_p2.png"></p>

<p><img src="./image/05-10_39_p18.png"></p>

<p><img src="./image/05-10_40_p87.png"></p>

- 輸出有兩種格式
  - 文字
  - 二位元

<p><img src="./image/05-10_41_p90.png"></p>

<p><img src="./image/05-10_42_p18.png"></p>

- 網頁緩衝區預設 8k，工作後再依照需要調整
  - 緩衝區放大，效能就會提升
- 緩衝區滿了連線就會斷喔

<p><img src="./image/05-10_43_p92.png"></p>

<p><img src="./image/05-10_44_p87.png"></p>

- 狀態碼

<p><img src="./image/05-10_45_p18.png"></p>

<p><img src="./image/05-10_46_p260.png"></p>

- 有 10 星應用

<p><img src="./image/05-10_47_p87.png"></p>

<p><img src="./image/05-10_48_p97.png"></p>

<p><img src='./image/05-10_49_p88.png'></p>

<p><img src='./image/05-10_50_p90.png'></p>

- 送給客戶端瀏覽器的資料需要使用 content type 設定檔案解析用標頭

<p><img src='./image/05-10_51_p17.png'></p>

- ms950 不要用，建議先使用 Big5 編碼，未未來轉為 UTF-8
  - UTF-8 會針對中(1byte)英文(3bytes)擴充或縮短空間(伸縮)
- shiftJIS 日文

<p><img src='./image/05-10_52_p89.png'></p>

<p><img src='./image/05-10_53_p78.png'></p>

- 背起來
- 只能送文字，或是送圖片

<p><img src='./image/05-10_54_p90.png'></p>

<p><img src='./image/05-10_56_code.png'></p>

- 狀態不合法的意外

<p><img src='./image/05-10_57_code.png'></p>

<p><img src='./image/05-10_58_p20.png'></p>

<p><img src='./image/05-10_59_p4.png'></p>

<p><img src='./image/05-10_60_p92.png'></p>

- 貓會幫忙 reset

<p><img src='./image/05-10_61_p97.png'></p>

<p><img src='./image/05-10_62_p92.png'></p>

<p><img src='./image/05-10_63_p147.png'></p>

- 在這邊 print 只是為了解釋被清除的過程
- 清除，指的是 92 的 reset() 方法 ，`貓做的`(伺服器幫忙呼叫的)
- 傳書的資料超過 8k，是自己的問題(程式結構有問題)

<p><img src='./image/05-10_64_p148.png'></p>

1. `程式結構有問題`，找老師協助除錯
2. 上班時結構有問題找同事

<p><img src='./image/05-10_65_p90.png'></p>

<p><img src='./image/05-10_66_code.png'></p>

<p><img src='./image/05-10_67_p91.png'></p>

- socket (插座) 是個 java 物件，傳遞物件的通道
- 是 internet 上兩個遠端的端點，用這兩個端點傳輸資料

<p><img src='./image/05-10_68_code.png'></p>

- 第三類 可隨時變動 (很重要的話使用)
- 第四類 號碼固定 (資料庫使用)

<p><img src='./image/05-10_69_code.png'></p>

<p><img src='./image/05-10_70_p10.png'></p>

- 保持活著

<p><img src='./image/05-10_71_p91.png'></p>

- 傳輸資料沒超過緩衝區，則可取得資料長度
- 緩衝區一設定這段空間就會留下來只給這程式用，緩衝區設定太大記憶體就無法使用

<p><img src='./image/05-10_72_p18.png'></p>

- setBufferSize() 控制緩衝區大小，只能適度放大
- 上網平均 3.6 秒的耐心等待時間，超過的話就不想用這網站了
- 開關耐性 0 秒

<p><img src='./image/05-10_73_p92.png'></p>

- 執行此文件出現 400 錯誤，很正常‧

<p><img src='./image/05-10_74_p94.png'></p>

<p><img src='./image/05-10_75_code.png'></p>

- 不同瀏覽器顯示方式不同
- chrome 只有將 `<html></html>` 寫出，才會判斷為 html 標籤

<p><img src='./image/05-10_77_code.png'></p>

<p><img src='./image/05-10_78_code.png'></p>

- 緩衝區大小設定的話，湯姆貓可能會給更多空間

<p><img src='./image/05-10_79_code.png'></p>

- 罵人罵完才說要收回

<p><img src='./image/05-10_80_code.png'></p>

<p><img src='./image/05-10_81_code.png'></p>

- log 有兩個來源

<p><img src='./image/05-10_82_p106.png'></p>

- log 位置

<p><img src='./image/05-10_84.png'></p>

- 貓 > 溢出(質不一定) > reset > boom

# Log 練習

```cs
log路徑: "C:\EA102_WebApp\apache-tomcat-9.0.35\logs"
```

# 檔案上傳

- 前端結構

```html
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=Big5" />
    <title>Upload.html</title>
  </head>
  <body>
    <form
      action="uploadServlet3.do"
      method="post"
      enctype="multipart/form-data"
    >
      <input type="file" name="upfile1" />
      <br />
      <input type="file" name="upfile2" />

      <input type="submit" value="上傳" />
    </form>
  </body>
</html>
```

- 後端完整寫法

```java
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.*;
import javax.servlet.annotation.WebServlet;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.http.Part;

@WebServlet("/uploadServlet3.do")
@MultipartConfig(fileSizeThreshold = 1024 * 1024, maxFileSize = 5 * 1024 * 1024, maxRequestSize = 5 * 5 * 1024 * 1024)
// 當數據量大於fileSizeThreshold值時，內容將被寫入磁碟
// 上傳過程中無論是單個文件超過maxFileSize值，或者上傳的總量大於maxRequestSize 值都會拋出IllegalStateException 異常
public class UploadTest_Servlet3 extends HttpServlet {
  private static final long serialVersionUID = 1L;
  String saveDirectory = "/images_uploaded"; // 上傳檔案的目的地目錄;
                         // 將由底下的第26~30行用 java.io.File 於 ContextPath 之下, 自動建立目地目錄

  public void doPost(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    req.setCharacterEncoding("Big5"); // 處理中文檔名
    res.setContentType("text/html; charset=Big5");
    PrintWriter out = res.getWriter();
    System.out.println("ContentType="+req.getContentType()); // 測試用

    String realPath = getServletContext().getRealPath(saveDirectory);
    System.out.println("realPath="+realPath); // 測試用
    File fsaveDirectory = new File(realPath);
    if (!fsaveDirectory.exists())
       fsaveDirectory.mkdirs(); // 於 ContextPath 之下,自動建立目地目錄

    Collection<Part> parts = req.getParts(); // Servlet3.0新增了Part介面，讓我們方便的進行檔案上傳處理
    out.write("<h2> Total parts : " + parts.size() + "</h2>");

    for (Part part : parts) {
      String filename = getFileNameFromPart(part);
      if (filename!= null && part.getContentType()!=null) {
        out.println("<PRE>");
        String name = part.getName();
        String ContentType = part.getContentType();
        long size = part.getSize();
        File f = new File(fsaveDirectory, filename);

        out.println("getIpAddress: " + getIpAddress(req));
        out.println("name: " + name);
        out.println("filename: " + filename);
        out.println("ContentType: " + ContentType);
        out.println("size: " + size);
        out.println("File: " + f);

        // 利用File物件,寫入目地目錄,上傳成功
        part.write(f.toString());

        // 額外測試 InputStream 與 byte[] (幫將來model的VO預作準備)
//        InputStream in = part.getInputStream();
//        byte[] buf = new byte[in.available()];
//        in.read(buf);
//        in.close();
//        out.println("buffer length: " + buf.length);

        // 額外測試秀圖
        out.println("<br><img src=\""+req.getContextPath()+saveDirectory+"/"+filename+"\">");

        out.println();
        out.println("</PRE>");
      }
    }
  }

  // 取出上傳的檔案名稱 (因為API未提供method,所以必須自行撰寫)
  public String getFileNameFromPart(Part part) {
    String header = part.getHeader("content-disposition");
    System.out.println("header=" + header); // 測試用
    String filename = new File(header.substring(header.lastIndexOf("=") + 2, header.length() - 1)).getName();
    System.out.println("filename=" + filename); // 測試用
    if (filename.length() == 0) {
      return null;
    }
    return filename;
  }

  public static String getIpAddress(HttpServletRequest request) {
      String ip = request.getHeader("x-forwarded-for");
      if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
          ip = request.getHeader("Proxy-Client-IP");
      }
      if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
          ip = request.getHeader("WL-Proxy-Client-IP");
      }
      if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
          ip = request.getRemoteAddr();
      }
      if (ip.contains(",")) {
          return ip.split(",")[0];
      } else {
          return ip;
      }
  }
}
```

- 簡單寫法

```java
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.WebServlet;
import javax.servlet.annotation.MultipartConfig;

@WebServlet("/uploadServlet3_simple.do")
@MultipartConfig
public class UploadTest_Servlet3_Simple extends HttpServlet {
  private static final long serialVersionUID = 1L;

  public void doPost(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    req.getPart("upfile1").write(getServletContext().getRealPath("/images_uploaded")+"/file.gif");

  }
}
```

- 簡單還原到稍微複雜

<p><img src="./image/05-10_20_code.png"></p>
