- res.sendRedirect() 這行使用為主，但考試不怎麼考

  - res.setStatus() 考試用而已

- location 的文字是在 263

<p><img src='./image/05-12_01_p97.png'></p>

- 資料沒滿就衝出去，系統 reset，跳轉時資料溢出

<p><img src='./image/05-12_02_p92.png'></p>

<p><img src='./image/05-12_03_p91.png'></p>

<p><img src='./image/05-12_04_p263.png'></p>

<p><img src='./image/05-12_05_p242.png'></p>

<p><img src='./image/05-12_06_p241.png'></p>

<p><img src='./image/05-12_06_p242.png'></p>

<p><img src='./image/05-12_07_p98.png'></p>

<p><img src='./image/05-12_08_p150.png'></p>

- 一邊一國

<p><img src='./image/05-12_09_p35.png'></p>

<p><img src='./image/05-12_10_p97.png'></p>

<p><img src='./image/05-12_11_p97.png'></p>

- refresh 用於非跟資料庫做請求的連線，刷記憶體適合，刷 localstorge? servletContext

<p><img src='./image/05-12_12_p98.png'></p>

<p><img src='./image/05-12_13_code.png'></p>

- 計時請使用 js，refresh 會從第一行開始執行，refresh 主要刷新記憶體的資料，若要刷新資料庫的請將時間拉長

<p><img src='./image/05-12_17_p101.png'></p>

- 這三組超實用
- proxy 代理伺服器

<p><img src='./image/05-12_18_p99.png'></p>

<p><img src='./image/05-12_19_p261.png'></p>

<p><img src='./image/05-12_20_p264.png'></p>

<p><img src='./image/05-12_23_p273.png'></p>

- 方法 1: 跳出視窗
- 方法 2: 修改錯誤提示字

<p><img src='./image/05-12_24_p100.png'></p>

<p><img src='./image/05-12_26_p101.png'></p>

<p><img src='./image/05-12_25_p102.png'></p>

<p><img src='./image/05-12_29_p162.png'></p>

<p><img src='./image/05-12_30_p163.png'></p>

<p><img src='./image/05-12_31_p173.png'></p>

- throw 出去讓呼叫這方法執行的人做
  1. 貓處裡
     1. 伺服器處裡
     2. web.xml 處裡
  2. main 處裡

<p><img src='./image/05-12_32_p103.png'></p>

<p><img src='./image/05-12_33_p104.png'></p>

<p><img src='./image/05-12_34_p101.png'></p>

<p><img src='./image/05-12_35_p105.png'></p>

- **維持狀態很重要**
- 維持狀態的做法
  - **傳統作法**: 都有安全上的漏洞
    - 隱藏欄位
    - URL 重寫
    - COOKIE
  - **進階作法**
    - 使用 Session Tracking API

<p><img src='./image/05-12_38_p107.png'></p>

<p><img src='./image/05-12_43_p108.png'></p>

- 傳送一般資料很方便
  - 可以查看購物車範例(在講義最末)
  - `別傳送敏感資料`

<p><img src='./image/05-12_39_p110.png'></p>

- `/?param=XXX` 額外路徑資訊
  - p.76 的第六個方法
  - 不支持 cookie 的瀏覽器或 cookie 的才有用
  - 此方法會有長度限制，不要傳太長的資料
  - java 的很多功能就是又難用又重要
  - 不要看書籍中所說(用 hidden 與 get 方式寫購物車的例子)
  - 傳輸長度: 2K+35，即 2083 字節
    - post 可可以 2M

<p><img src='./image/05-12_40_p111.png'></p>

- `cookie`
  - 是個小小的文字檔
  - 保存資料的時間比 hidden 更久
  - 可以拒絕伺服端要存的 cookie
    - 瀏覽器可以設定拒絕提供 cookie 功能
  - 大小只有 4k
  - 使用範例: 股票查詢
- Netscape 公司研發出
  - cookie
  - SSL (p.244)

<p><img src='./image/05-12_41_p112.png'></p>

- 最好的做法

<p><img src='./image/05-12_42_p115.png'></p>

<p><img src='./image/05-12_44_p92.png'></p>

- `Session Tracking API`
  - **範例**: 購物車
- `Authentication`
  - **範例**: 維持登入狀態
  - p.71 的做法

<p><img src='./image/05-12_45_p109.png'></p>

<p><img src='./image/05-12_46_p71.png'></p>

<p><img src='./image/05-12_48_p244.png'></p>

<p><img src='./image/05-12_47_p114.png'></p>

- 今天不會說

<p><img src='./image/05-12_50_p123.png'></p>

<p><img src='./image/05-12_51_p115.png'></p>

<p><img src='./image/05-12_53_p116.png'></p>

- session 還在，並清除內容資料

<p><img src='./image/05-12_52_p117.png'></p>

- jessionid 認證考試會考
  - 靠 cookie，所以 cookie 封鎖就沒用了

<p><img src='./image/05-12_54_p120.png'></p>

- session.invalidate()
  - 整個 session 移除
  - 應用: 登出功能
- getMaxIntactiveInterval() 取出最大活動的時間段
- setMaxIntactiveInterval() 可以改時間
- getLastAccessedTime() 傳回上次取的時間，不常用

<p><img src='./image/05-12_55_p118.png'></p>

<p><img src='./image/05-12_56_p157.png'></p>

<p><img src='./image/05-12_57_p122.png'></p>

- xml 用分鐘
  - xml 科立度大
  - java 小

<p><img src='./image/05-12_58_p119.png'></p>

- 沒有 cookie 只好改成使用 url 方式替換

<p><img src='./image/05-12_54_p120.png'></p>

<p><img src='./image/05-12_59.png'></p>

- 程式片段 1: cookie 封鎖也可作用
- 程式片段 2: 路徑重導

<p><img src='./image/05-12_60_p121.png'></p>

<p><img src='./image/05-12_61_p122.png'></p>

- 專題用

<p><img src='./image/05-12_62_p173.png'></p>

<p><img src='./image/05-12_63_p117.png'></p>

# HTTPSession 範例

- 思考的邏輯是先放，程式的邏輯是先取(判斷空值時 new)

```cs
範例程式: "/SL314/src/servlet_examples/SessionTracker.java"
範例程式: "/SL314/src/servlet_examples/ManualInvalidate.java"
範例程式: "/SL314/src/servlet_examples/SessionSnoop.java"
```

# 購物車邏輯步驟

- **購物車流程**
  - new 購物車
  - add(可樂)
  - setAttribute(購物車)
  - getAttribute(購物車)
  - add(雞腿)
  - setAttribute(購物車)
  - getAttribute(購物車)
  - add(衛生紙)
  - setAttribute(購物車)
  - getAttribute(購物車)
  - add(貓砂)
  - setAttribute(購物車)
  - forEach(商品單價與數量)
  - removeAttribute
- **需要技術**
  - section
  - list
  - jdbc

# Cookie 測試

- 沒有單獨程式範例

<p><img src='./image/05-12_49_p113.png'></p>

# Session 測試

- cookie 封鎖後會無法傳送過去值，會導致無法取值 (因為根本沒辦法存入)

- 步驟 1: 設定瀏覽器封鎖所有 cookie

  - google 瀏覽器 > 設定 > Cookie 和其他網站資料 > 封鎖所有 Cookie (不建議)

- 步驟 2: 設定 Session

```java
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class Session_Set extends HttpServlet {


  public void doGet(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    res.setContentType("text/html; charset=Big5");
    PrintWriter out = res.getWriter();

    HttpSession session = req.getSession();
        session.setAttribute("myName2","吳永志2");

        String ID = session.getId();
        out.println("ID="+ID);

  }
}
```

```cs
ID=C7E7A82E206B1AC7EF5A4D06305EAE3F
```

- 步驟 3: 已設定 set 卻取到空值 (此結果正常)

```cs
範例程式: "/SL314/src/Session_Get.java"
```

```java
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class Session_Get extends HttpServlet {
  public void doGet(HttpServletRequest req, HttpServletResponse res)
      throws ServletException, IOException {

    res.setContentType("text/html; charset=Big5");
    PrintWriter out = res.getWriter();

    HttpSession session = req.getSession();
    Object myName2 = session.getAttribute("myName2");
    out.println(myName2);

    String ID = session.getId();
        out.println("<br>ID="+ID);
  }
}
```

```cs
null
ID=C13F81279833E2BA1205EC4AC75FA051
```

# 模擬 500 錯誤

- 沒這個數據， trim() 空值本身就錯

<p><img src='./image/05-12_37.png'></p>

```cs
範例程式: "C:\EA102_WebApp\apache-tomcat-9.0.35\webapps\IBM_9\WEB-INF\web.xml"
```

```xml
<?xml version="1.0" encoding="ISO-8859-1"?>

<!-- 以下為 Servlet2.3 、 Servlet2.4 、 Servlet2.5 、 Servlet3.0 、 Servlet3.1 、 Servlet4.0 各個Servlet版本的部署描述檔 web.xml 的頂層標籤 -->

<!--
<!DOCTYPE web-app
    PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
    "http://java.sun.com/dtd/web-app_2_3.dtd">
<web-app>
-->


<!--
<web-app xmlns="http://java.sun.com/xml/ns/j2ee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee
                      http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"
  version="2.4">
-->


<!--
<web-app xmlns="http://java.sun.com/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
                      http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
  version="2.5">
-->


<!--
<web-app xmlns="http://java.sun.com/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
  version="3.0"
  metadata-complete="false">
-->


<!--
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee
                      http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"
  version="3.1"
  metadata-complete="false">
-->


<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee
                      http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
  version="4.0"
  metadata-complete="false">


    <!-- <request-character-encoding>Big5</request-character-encoding> -->
    <!-- 使用資料庫連線池 DataSource-JNDI的設定 -->
    <resource-ref>
        <description>DB Connection</description>
        <res-ref-name>jdbc/TestDB</res-ref-name>
        <res-type>javax.sql.DataSource</res-type>
        <res-auth>Container</res-auth>
    </resource-ref>


    <servlet>                           <!-- 已經無法以註冊名稱(http://localhost:8081/IBM/servlet/hi)的方式執行,因為Invoker servlet的功能在Tomcat 7.x 已經被移除 -->
        <servlet-name>hi</servlet-name>
        <servlet-class>HelloWorld</servlet-class>
    </servlet>

    <servlet-mapping>                   <!-- 明確對應 http://localhost:8081/IBM/hello.html -->
        <servlet-name>hi</servlet-name>
        <url-pattern>/hello.html</url-pattern>
    </servlet-mapping>

    <servlet-mapping>                   <!-- 前置路徑對應 http://localhost:8081/IBM/hello.html/xxxxx -->
        <servlet-name>hi</servlet-name>
        <url-pattern>/hello.html/*</url-pattern>
    </servlet-mapping>

    <servlet-mapping>                   <!-- 延伸檔名對應 http://localhost:8081/IBM/xxx/yyy/zzz.mm-->
        <servlet-name>hi</servlet-name>
        <url-pattern>*.mm</url-pattern>
    </servlet-mapping>


    <!-- HelloWorld的第二個註冊名稱與mapping -->
    <servlet>
        <servlet-name>HelloWorld</servlet-name>
        <servlet-class>HelloWorld</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>HelloWorld</servlet-name>
        <url-pattern>/HelloWorld</url-pattern>
    </servlet-mapping>


    <!-- Hello的註冊名稱與mapping -->
    <servlet>
        <servlet-name>Hello</servlet-name>
        <servlet-class>Hello</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>Hello</servlet-name>
        <url-pattern>/Hello</url-pattern>
    </servlet-mapping>

    <!--注意當有用到【額外路徑資訊】時必須使用【前置路徑對應】的設定  -->
    <servlet>
      <servlet-name>PathServlet</servlet-name>
      <servlet-class>PathServlet</servlet-class>
    </servlet>
    <servlet-mapping>
      <servlet-name>PathServlet</servlet-name>
      <url-pattern>/PathServlet/*</url-pattern>
    </servlet-mapping>

<!-- HTTP身份驗證-Basic  HTTP Basic Authentication  , 【username 為 tomcat ; password 為 tomcat】【可查看tomcat-users.xml】-->
<!--
    <security-constraint>
        <web-resource-collection>
            <web-resource-name>
                SecretProtection
            </web-resource-name>
            <url-pattern>
                /*
            </url-pattern>

            <http-method>
                GET
            </http-method>
            <http-method>
                POST
            </http-method>
        </web-resource-collection>
        <auth-constraint>
            <role-name>
                tomcat
            </role-name>
        </auth-constraint>
    </security-constraint>

    <login-config>
        <auth-method>
            BASIC
        </auth-method>
        <realm-name>
            Default
        </realm-name>
    </login-config>

    <security-role>
        <role-name>
            tomcat
        </role-name>
    </security-role>
-->


<!-- error-page 錯誤網頁 -->

    <error-page>
        <error-code>
            400
        </error-code>
        <location>
            /error.html
        </location>
    </error-page>

    <error-page>
        <error-code>
            404
        </error-code>
        <location>
            /error.html
        </location>
    </error-page>

    <error-page>
        <error-code>
            500
        </error-code>
        <location>
            /error.html
        </location>
    </error-page>

    <error-page>
        <exception-type>
            javax.servlet.ServletException
        </exception-type>
        <location>
            /error.html
        </location>
    </error-page>


</web-app>


<!-- Servlet 3.0 開始的部署描述檔 web.xml 的頂層標籤 有一個 metadata-complete 屬性，該屬性指定當前的部署描述檔 web.xml 是否是完全的。 -->
<!-- 預設為false -->
<!-- 如果設置為 true，則在部署時將只依賴 web.xml，將忽略所有的Anotation註解（同時也會跳過 web-fragment.xml 的掃瞄，亦即禁用可插性支持）-->
<!-- 如果在web.xml、Anotation、web-fragment.xml中所設定的Servlet有同名的註冊名稱，則以web.xml中的設定為主（順序為web.xml -> Anotation -> web-fragment.xml）-->
```

```cs
範例程式: "C:\EA102_WebApp\apache-tomcat-9.0.35\webapps\IBM_9\WEB-INF\classes\Hello.java"
```

```java
//package servlet_examples;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class Hello extends HttpServlet {

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
     req.setCharacterEncoding("Big5");
    res.setContentType("text/html; charset=Big5");
    PrintWriter out = res.getWriter();

    String name = req.getParameter("name ").trim(); // 主要測試行
    out.println("<HTML>");
    out.println("<HEAD><TITLE>Hello, " + name + "</TITLE></HEAD>");
    out.println("<BODY>");
    out.println("Hello, 你好: " + name);

    out.println("<br><img src=\""+req.getContextPath()+"/images/tomcat.gif\">");
    out.println("<br><img src=\""+       "/IBM_9"      +"/images/tomcat.gif\">");
    out.println("<br><img src=\"          /IBM_9         /images/tomcat.gif\">");
    out.println("<br><img src=\"/IBM_9/images/tomcat.gif\">");
    out.println("<br><img src='/IBM_9/images/tomcat.gif'>");

    out.println("</BODY></HTML>");
  }

  public String getServletInfo() {
    return "A servlet that knows the name of the person to whom it's" +
           "saying hello";
  }
}
```

# 錯誤處裡 xml 設定範例

<p><img src='./image/05-12_27.png'></p>

# 錯誤碼範例

```cs
範例程式: "/SL314/src/servlet_examples/Buffering.java"
```

```html
<%@ page contentType="text/html; charset=Big5" pageEncoding="Big5"%> <%
response.setHeader("Cache-Control","no-store"); //HTTP 1.1
response.setHeader("Pragma","no-cache"); //HTTP 1.0 response.setDateHeader
("Expires", 0); %>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=BIG5" />
    <title>form1.jsp</title>
  </head>
  <body>
    <form method="POST" action="Hello">
      請輸入您的名字!
      <input type="TEXT" name="name" value="peter1吳永志" />
      <p>
        <input type="SUBMIT" />
      </p>
    </form>

    <img src="images/tomcat.gif" />

    <table border="1" bordercolor="blue">
      <tr>
        <th>數字</th>
        <th>平方</th>
      </tr>

      <% for (int i=0 ; i<10 ; i++) { %>
      <tr>
        <td><%= i %></td>
        <td><%= i*i %></td>
      </tr>
      <% } %>
    </table>

    <%! int count=0; %> (本網頁)第 <%= ++count %> 次拜訪
    <br />
  </body>
</html>
```

# 過濾器測試

```cs
範例程式: "C:\Users\USER\Desktop\SL314_Servlet4課程分享\SL314_課程中分享\19_○過濾器-Filter(webapps)\SL314_Filter2\form1.jsp"
```

```html
<%@ page contentType="text/html; charset=Big5" pageEncoding="Big5"%> <%
response.setHeader("Cache-Control","no-store"); //HTTP 1.1
response.setHeader("Pragma","no-cache"); //HTTP 1.0 response.setDateHeader
("Expires", 0); %>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=BIG5" />
    <title>form1.jsp</title>
  </head>
  <body>
    <form method="POST" action="Hello">
      請輸入您的名字!
      <input type="TEXT" name="name" value="peter1吳永志" />
      <p>
        <input type="SUBMIT" />
      </p>
    </form>

    <img src="images/tomcat.gif" />

    <table border="1" bordercolor="blue">
      <tr>
        <th>數字</th>
        <th>平方</th>
      </tr>

      <% for (int i=0 ; i<10 ; i++) { %>
      <tr>
        <td><%= i %></td>
        <td><%= i*i %></td>
      </tr>
      <% } %>
    </table>

    <%! int count=0; %> (本網頁)第 <%= ++count %> 次拜訪
    <br />
  </body>
</html>
```

```cs
範例程式: "C:\Users\USER\Desktop\SL314_Servlet4課程分享\SL314_課程中分享\19_○過濾器-Filter(webapps)\SL314_Filter2"
```

```java
//package servlet_examples;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class HelloWorld extends HttpServlet {

  int count = 0;

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
    doPost(req, res);

  }

  public void doPost(HttpServletRequest req, HttpServletResponse res)
                                throws ServletException, IOException {
    res.setBufferSize(8*1024);


    res.setContentType("text/html; charset=Big5");
    PrintWriter out = res.getWriter();

    int size = res.getBufferSize();
    log("The default buffer size is" + size);

    res.setHeader("Cache-Control","no-store"); //HTTP 1.1
    res.setHeader("Pragma","no-cache");        //HTTP 1.0
    res.setDateHeader ("Expires", 0);

    out.println("<HTML>");
    out.println("<HEAD><TITLE>Hello World</TITLE></HEAD>");
    out.println("<BODY>");
    out.println("<BIG>Hello World , 世界你好2 !</BIG>"+(++count));
    out.println("</BODY></HTML>");
  }
}
```

# proxy 解釋

- 要記得`近端不用Prox伺服器`要勾，減少不必要的資源損耗

<p><img src='./image/05-12_21.png'></p>

<p><img src='./image/05-12_22.png'></p>

# setHeader(Location) 測試

- 隨機跳轉頁面

```cs
範例程式: "/SL314/src/servlet_examples/SiteSelector.java"
```

```java
package servlet_examples;

import java.io.*;
import java.util.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class SiteSelector extends HttpServlet {

  Vector<String> sites = new Vector<String>();
  Random random = new Random();

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
    res.setContentType("text/html");
    PrintWriter out = res.getWriter();

    int siteIndex = Math.abs(random.nextInt()) % sites.size();
    String site = sites.get(siteIndex);

    res.setStatus(HttpServletResponse.SC_FOUND);
    res.setHeader("Location", site);
  }
  public void init() throws ServletException {
    sites.add("http://www.oracle.com/technetwork/java/index.html");
    sites.add("http://www.apache.org/");
    sites.add("http://struts.apache.org/");
    sites.add("https://tw.yahoo.com");
  }
}
```

<p><img src='./image/05-12_14_code.png'></p>

# setHeader(Refresh) 測試

- 刷新設定

```cs
範例程式: "/SL314/src/servlet_examples/ClientPull.java"
```

```java
package servlet_examples;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class ClientPull extends HttpServlet {

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
    res.setContentType("text/plain");
    PrintWriter out = res.getWriter();

    res.setHeader("Refresh", "1");
    out.println(new java.util.Date());
  }
}
```

<p><img src='./image/05-12_15_code.png'></p>

# getRequestURI() 測試

- 頁面路徑作用

```cs
範例程式: "/SL314/src/servlet_examples/ClientPullMove.java"
```

```java
package servlet_examples;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class ClientPullMove extends HttpServlet {

  static final String NEW_HOST = "https://tw.yahoo.com";

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
    res.setContentType("text/html");
    PrintWriter out = res.getWriter();

    String newLocation = NEW_HOST + req.getRequestURI();
    String newLocation2 = NEW_HOST + "/SL314/ClientPullMove";

    res.setHeader("Refresh", "10; URL=" + newLocation);

    out.println("The requested URI has been moved to a different host.<BR>");
    out.println("Its new location is " + newLocation + "<BR>");
    out.println("Your browser will take you there in 10 seconds.");
  }
}
```

<p><img src='./image/05-12_16_code.png'></p>

---

參考鏈接:

- [页面刷新的 reload()和 refresh()方法有什么不同](https://blog.csdn.net/kakaxiD/article/details/51799718)
- [response.setHeader 的各种用法](https://blog.csdn.net/junmoxi/article/details/76976692)
- [Java 中 session 的用法](https://zhuanlan.zhihu.com/p/27117070)
- [HTTP 基本認證(Basic Authentication)的 JAVA 示例](https://www.itread01.com/content/1547788703.html)
- [java 中 request.getSession(true、false、null)的區別](https://codertw.com/%E7%A8%8B%E5%BC%8F%E8%AA%9E%E8%A8%80/312110/)
- [GET 與 POST 的區別與優缺點](http://www.webpage.idv.tw/study/03/09/method.htm)
- [網頁研習室](http://www.webpage.idv.tw/study/)
