<h1 id="top">目錄</h1>

- [1. execute 實際執行](#s1)
- [2. 資料庫取值練習 3](#s2)
- [3. DB 連線資料讀取練習](#s3)
- [4. JDBC 創建練習](#s4)
- [5. JDBC 連線測試](#s5)
- [6. 測試資料庫是否正常](#s6)
- [7. session 結論](#s7)

---

<p><img src='./image/05-13_01_p122.png'></p>

<p><img src='./image/05-13_02_code.png'></p>

<p><img src='./image/05-13_03_code.png'></p>

- 與上面那張的區別仍可自動裝拆箱，這在 session 中，session 沒有變那資料會繼續疊加

<p><img src='./image/05-13_04_code.png'></p>

- 執行這程式當下的時間 System.currentTimeMillis() 取出當下毫秒數(1971.01.01 開始)

<p><img src='./image/05-13_05_code.png'></p>

<p><img src='./image/05-13_06_p118.png'></p>

<p><img src='./image/05-13_07_code.png'></p>

- 此程式資料主要是測試使用

<p><img src='./image/05-13_08_code.png'></p>

- res.encodeURL() 重新改寫 URL

<p><img src='./image/05-13_09_p120.png'></p>

- 使用 URL Writer 的方法會使所有人共同連線，紀錄仍會持續疊加，
  即同一線路，認 session id
- IE 瀏覽器，只要點著 F5 就會一直刷新網站

```java
http://192.168.1.117:8081/SL314/SessionSnoop;jsessionid=9AFDD953D790851017AFA73645845C80
```

<p><img src='./image/05-13_10.png'></p>

<p><img src='./image/05-13_11.png'></p>

- 沒有設定 session 就沒有，沒人為的設定就沒有

<p><img src='./image/05-13_12.png'></p>

<p><img src='./image/05-13_13_p122.png'></p>

- p137~9 要注意

<p><img src='./image/05-13_14_p137.png'></p>

<p><img src='./image/05-13_15_p124.png'></p>

<p><img src='./image/05-13_16_p126.png'></p>

<p><img src='./image/05-13_18_p69.png'></p>

- DB2 銀行
- MySql 沒錢的
- SQLServer 中小型

<p><img src='./image/05-13_19.png'></p>

<p><img src='./image/05-13_20_p125.png'></p>

<p><img src='./image/05-13_21_p437.png'></p>

<p><img src='./image/05-13_22_p127.png'></p>

- ResultSet executeQuery("Select...")
- int executeUpdate("insert...")
- int executeUpdate("delete...")
- int executeUpdate("DDL...")
- boolean execute("未知的 SQL")

<p><img src='./image/05-13_23_p128.png'></p>

<p><img src='./image/05-13_24_p35.png'></p>

<p><img src='./image/05-13_25_p27.png'></p>

- `out.println(new HtmlResultSet(rs));`
- `out.println(new HtmlSQLResult("未知的 SQL", con));`

<p><img src='./image/05-13_26_p128.png'></p>

<p><img src='./image/05-13_27_p68.png'></p>

- 以後不希望在程式中直接看見 SQL，所以不行用此程式碼
- 主要是在小專案中做

<p><img src='./image/05-13_28.png'></p>

<p><img src='./image/05-13_29_p172.png'></p>

- 執行次數
  - 1 次
  - n 次
  - 1 次

<p><img src='./image/05-13_30_p129.png'></p>

<p><img src='./image/05-13_31_p130.png'></p>

<p><img src='./image/05-13_32_p132.png'></p>

<p><img src='./image/05-13_33_p131.png'></p>

<p><img src='./image/05-13_34_p438.png'></p>

<p><img src='./image/05-13_35_p1.png'></p>

<p><img src='./image/05-13_36_p116.png'></p>

<p><img src='./image/05-13_37_p2.png'></p>

<p><img src='./image/05-13_38_p142.png'></p>

<p><img src='./image/05-13_39_p146.png'></p>

<p><img src='./image/05-13_40_p149.png'></p>

<p><img src='./image/05-13_41_p152.png'></p>

<p><img src='./image/05-13_42_p156.png'></p>

<p><img src='./image/05-13_43_p132.png'></p>

<p><img src='./image/05-13_44_p141.png'></p>

<p><img src='./image/05-13_45_p142.png'></p>

<p><img src='./image/05-13_46_p143.png'></p>

<p><img src='./image/05-13_47_p132.png'></p>

<p><img src='./image/05-13_48_p134.png'></p>

<p><img src='./image/05-13_49_p139.png'></p>

<p><img src='./image/05-13_50_p133.png'></p>

<p><img src='./image/05-13_51_p437.png'></p>

<p><img src='./image/05-13_52_p135.png'></p>

# <a id='s1' class='md-title' href='#top'>1. execute 實際執行</a>

```cs
"/SL314/src/servlet_examples/HtmlSQLResult.java"
```

```java
package servlet_examples;

import java.sql.*;

public class HtmlSQLResult {
  private String sql;
  private Connection con;

  public HtmlSQLResult(String sql, Connection con) {
    this.sql = sql;
    this.con = con;
  }
  public String toString() {  // can be called at most once
    StringBuffer out = new StringBuffer();

    // Uncomment the following line to display the SQL command at start of table
    // out.append("Results of SQL Statement: " + sql + "<P>\n");

    try {
      Statement stmt = con.createStatement();

      if (stmt.execute(sql)) {
        // There's a ResultSet to be had
        ResultSet rs = stmt.getResultSet();
        out.append("<TABLE>\n");

        ResultSetMetaData rsmd = rs.getMetaData();

        int numcols = rsmd.getColumnCount();

        // Title the table with the result set's column labels
        out.append("<TR>");
        for (int i = 1; i <= numcols; i++)
          out.append("<TH>" + rsmd.getColumnLabel(i));
        out.append("</TR>\n");

        while(rs.next()) {
          out.append("<TR>");  // start a new row
          for(int i = 1; i <= numcols; i++) {
            out.append("<TD>");  // start a new data element
            Object obj = rs.getObject(i);
            if (obj != null)
              out.append(obj.toString());
            else
              out.append("&nbsp;");
            }
          out.append("</TR>\n");
        }

        // End the table
        out.append("</TABLE>\n");
      }
      else {
        // There's a count to be had
        out.append("<B>Records Affected:</B> " + stmt.getUpdateCount());
      }
    }
    catch (SQLException e) {
      out.append("</TABLE><H1>ERROR:</H1> " + e.getMessage());
    }

    return out.toString();
  }
}
```

```cs
"/SL314/src/servlet_examples/DBPhoneLookup.java"
```

```java
package servlet_examples;

import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class DBPhoneLookup extends HttpServlet {

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
    Connection con = null;

    res.setContentType("text/html; charset=BIG5");
    PrintWriter out = res.getWriter();

    try {
      // Load (and therefore register) the Oracle Driver
      Class.forName("oracle.jdbc.driver.OracleDriver");

      // Get a Connection to the database
      con = DriverManager.getConnection("jdbc:oracle:thin:@localhost:1521:XE", "EA102", "123456");

      // Display the result set as a list
      out.println("<HTML><HEAD><TITLE>Phonebook</TITLE></HEAD>");
      out.println("<BODY>");
      out.println("<UL>");

      out.println(new HtmlSQLResult("SELECT * FROM emp2", con));

      out.println("</UL>");
      out.println("</BODY></HTML>");
    }
    catch(ClassNotFoundException e) {
      out.println("Couldn't load database driver: " + e.getMessage());
    }
    catch(SQLException e) {
      out.println("SQLException caught: " + e.getMessage());
    }
    finally {
      // Always close the database connection.
      try {
        if (con != null) con.close();
      }
      catch (SQLException ignored) { }
    }
  }
}
```

# <a id='s2' class='md-title' href='#top'>2. 資料庫取值練習 3</a>

- 取出表中所有資料

```cs
"/SL314/src/servlet_examples/HtmlResultSet.java"
```

```java
package servlet_examples;

import java.sql.*;

public class HtmlResultSet {

  private ResultSet rs;

  public HtmlResultSet(ResultSet rs) {
    this.rs = rs;
  }
  public String toString() {  // can be called at most once
    StringBuffer out = new StringBuffer();
    // Start a table to display the result set
    out.append("<TABLE border=1 bordercolor=cadetblue >\n");

    try {
      ResultSetMetaData rsmd = rs.getMetaData();

      int numcols = rsmd.getColumnCount();

      // Title the table with the result set's column labels
      out.append("<TR>");
      for (int i = 1; i <= numcols; i++) {
        out.append("<TH>" + rsmd.getColumnLabel(i));
      }
      out.append("</TR>\n");

      while(rs.next()) {
        out.append("<TR>"); // start a new row
        for (int i = 1; i <= numcols; i++) {
          out.append("<TD>"); // start a new data element
          Object obj = rs.getObject(i);
          if (obj != null)
            out.append(obj.toString());
          else
            out.append("&nbsp;");
        }
        out.append("</TR>\n");
      }

      // End the table
      out.append("</TABLE>\n");
    }
    catch (SQLException e) {
      out.append("</TABLE><H1>ERROR:</H1> " + e.getMessage() + "\n");
    }

    return out.toString();
  }
}
```

```cs
"/SL314/src/servlet_examples/DBPhoneLookup.java"
```

```java
package servlet_examples;

import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class DBPhoneLookup extends HttpServlet {

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
    Connection con = null;
    Statement stmt = null;
    ResultSet rs = null;

    res.setContentType("text/html; charset=Big5");
    PrintWriter out = res.getWriter();

    try {
      // Load (and therefore register) the Oracle Driver
      Class.forName("oracle.jdbc.driver.OracleDriver");

      // Get a Connection to the database
      con = DriverManager.getConnection("jdbc:oracle:thin:@localhost:1521:XE", "EA102", "123456");

      // Create a Statement object
      stmt = con.createStatement();

      // Execute an SQL query, get a ResultSet
      rs = stmt.executeQuery("SELECT * FROM emp2"); // 取出表中所有資料
      // rs = stmt.executeQuery("SELECT EMPNO xxx, ENAME yyy FROM EMP2"); // 取出指定資料，用別名顯示

      // Display the result set as a list
      out.println("<HTML><HEAD><TITLE>Phonebook</TITLE></HEAD>");
      out.println("<BODY>");
      out.println("<UL>");

      out.println(new HtmlResultSet(rs));

      out.println("</UL>");
      out.println("</BODY></HTML>");
    }
    catch(ClassNotFoundException e) {
      out.println("Couldn't load database driver: " + e.getMessage());
    }
    catch(SQLException e) {
      out.println("SQLException caught: " + e.getMessage());
    }
    finally {
      // Always close the database connection.
      try {
        if (con != null) con.close();
      }
      catch (SQLException ignored) { }
    }
  }
}
```

- JDBC 跟 IO 取值是由 1 開始

# <a id='s3' class='md-title' href='#top'>3. DB 連線資料讀取練習</a>

```cs
"/SL314/src/servlet_examples/DBPhoneLookup.java"
```

```java
package servlet_examples;

import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class DBPhoneLookup extends HttpServlet {

  public void doGet(HttpServletRequest req, HttpServletResponse res)
                               throws ServletException, IOException {
    Connection con = null;
    Statement stmt = null;
    ResultSet rs = null;

    res.setContentType("text/html; charset=Big5");
    PrintWriter out = res.getWriter();

    try {
      // Load (and therefore register) the Oracle Driver
      Class.forName("oracle.jdbc.driver.OracleDriver");

      // Get a Connection to the database
      con = DriverManager.getConnection("jdbc:oracle:thin:@localhost:1521:XE", "EA102", "123456");

      // Create a Statement object
      stmt = con.createStatement();

      // Execute an SQL query, get a ResultSet
      rs = stmt.executeQuery("SELECT empno, ename FROM emp2");

      // Display the result set as a list
      out.println("<HTML><HEAD><TITLE>Phonebook</TITLE></HEAD>");
      out.println("<BODY>");
      out.println("<UL>");
      while(rs.next()) {
        out.println("<LI>" + rs.getString(1) + " " + rs.getString(2));
      }
      out.println("</UL>");
      out.println("</BODY></HTML>");
    }
    catch(ClassNotFoundException e) {
      out.println("Couldn't load database driver: " + e.getMessage());
    }
    catch(SQLException e) {
      out.println("SQLException caught: " + e.getMessage());
    }
    finally {
      // Always close the database connection.
      try {
        if (con != null) con.close();
      }
      catch (SQLException ignored) { }
    }
  }
}
```

<p><img src='./image/05-13_17_code.png'></p>

# <a id='s4' class='md-title' href='#top'>4. JDBC 創建練習</a>

- file > project > 左按鈕 > 引入 Oracle 資料

- 接著運行連線測試中的程式碼

# <a id='s5' class='md-title' href='#top'>5. JDBC 連線測試</a>

```cs
檔案路徑: "C:\javawork_jdbc_XE\0_basic\01_基礎_JDBC_ORACLE\Oracle_Basic1.java"
```

```java
import java.sql.*;

class Oracle_Basic1 {

    public static void main(String argv[]) {
        try {
            Class.forName("oracle.jdbc.driver.OracleDriver");  //驅動程式-第四類

            Class.forName("sun.jdbc.odbc.JdbcOdbcDriver");     //驅動程式-第一類: JDBC-ODBC橋接器 (Java 8 開始,已不再支援)
            //至 設定-控制台-系統管理工具-資料來源(ODBC)
            //-> 選擇系統資料來源名稱->新增->選Oracle in XE->完成
            //-> [Data Source Name(資料來源名稱)\輸入:dsn1] [TNS Service Name\選擇:XE] [User ID\輸入:hr] [OK] -> 確定
        } catch (java.lang.ClassNotFoundException e) {
            System.err.print("ClassNotFoundException: ");
            System.err.println(e.getMessage());
        }

        try {
            Connection con =  DriverManager.getConnection("jdbc:oracle:thin:@localhost:1521:XE", "EA102", "123456");
            //Connection con =  DriverManager.getConnection("jdbc:odbc:dsn1", "scott", "tiger");

            Statement stmt = con.createStatement();
            ResultSet rs = stmt.executeQuery("SELECT * from emp2");

            while (rs.next()) {
                String str1 = rs.getString(1);
                String str2 = rs.getString(2);

                System.out.print(" EMPNO= " + str1);
                System.out.print(" ENAME= " + str2);
                System.out.print("\n");
            }

            rs.close();
            stmt.close();
            con.close();

        } catch (SQLException ex) {
            System.err.println("SQLException: " + ex.getMessage());
        }
    }
}
```

# <a id='s6' class='md-title' href='#top'>6. 測試資料庫是否正常</a>

- 步驟 1

```cs
測試資料庫是否正常: "/SL314/src/Test_DataSource.java"
```

- 步驟 2: 一般步驟 1 可以成功，這一步也能成功

```cs
資料位置: "/IBM_emp_01MVC_Basic_css/WebContent/emp/select_page.jsp"
測試資料庫是否正常: "http://localhost:8081/IBM_emp_01MVC_Basic_css/emp/select_page.jsp"
```

# <a id='s7' class='md-title' href='#top'>7. session 結論</a>

- session 是人為的
- 伺服器【正常關閉】時會將資料序列化，所以 session 若之前時間還活著那就不會消失
- 如果按【X】則 session 不會序列化，只是單純 localhost 測試 session 而不小心用按【X】關閉伺服器的話影響不大，但還是要注意
