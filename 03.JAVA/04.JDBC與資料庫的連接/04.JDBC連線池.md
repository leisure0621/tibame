# 連線池管理

- 對於一個 Web 應用系統來說,連線有可能產生以下問題:

  - 資料庫連結過於頻繁,造成整個系統執行效率低落
  - 佔用連線後,卻又很少執行程式造成浪費 (如 servlet init()方法使用)
  - 使用一個連線後,執行程式頻率極高,可能造成多個執行緒同時共用一個連線的不正常情況 (資料異動時不能共用同一個連線)

- 連線池 (Connection Pool)

  - 是一種對 Connection 物件的管理機制,為解決上述問題的方案之一
  - 系統啟動初期,Conneciton Pool 就會預先建立幾個連線物件,並開始執掌分配連線物件

- Connection Pool 實作

  - 可由 Application Server(如 `Tomcat`, WebSphere, WebLogic)提供
  - 驅動程式內也可以處理 Conneciton Pool
  - 或是處理 Connection Pool 的`商業產品套件`
  - `免費的連線池`: `Apache DBCP`, `C3P0`, `Proxool` 等
    - 未來學習的框架: Hibernate(著名的 ORM 框架)

- 連線管理程式

  - 範例:ConnPool.java + SQLAgent.java + TestThread.java
  - 使用 javax.sql.DataSource(資料來源介面)
    - `這些介面我們不須實作，因為是連線池套件去實作`
  - JDBC 2.0 標準延伸 API(Standard Extension API)裡引入的 DataSource 介面是目前連上資料庫的 DriverManager 類別的最佳替代方案
  - 一個 DataSource 物件就代表一個資料庫,應用程式可以間接透過這個物件以取得資料庫 Connection 物件
  - 要配置 DataSource 物件來產生連線池,需先有 ConnectionPoolDataSource 介面的物件

```java
public interface DataSource {
  Connection getConnection() throws SQLException;
  ...
}
```

- 實際上對於 DataSource 的取得,我們的應用程式更常藉由 JNDI(JavaNaming and Directory Interface),從 Servlet Container 取得已設定好的 DataSource,再從 DataSource 取得資料庫連線物件

- 如:

```java
javax.naming.Context ctx = new javax.naming.InitialContext();
DataSource ds = (DataSource) ctx.lookup(“jdbc/XXX”);
Connection con = ds.getConnection();
```

- Java 程式內無須再註冊驅動程式,也不必透過 DriverManager 提供 URL,USER & PASSWORD,JDBC 已經發現了命名與目錄服務

- Java 應用程式只須向 JDBC DataSource 交談即可

- DataSource 會自行和 ConnectionPoolDataSource 交談

- ConnectionPoolDataSource 儲存的就是放在連線池裡的資料庫連線。當應用程式呼叫 DataSource 實體的 getConnection()方法時,getConnection()方法即會從連線池裡取出一個連線物件,應用程式就能利用此物件一直到工作完成

- 工作完成之後,應用程式正常關閉連線,但應用程式並不會知道實際上此連線與資料庫沒有中斷。close()方法將連線歸還到連線池裡,若是要再使用連線,需要再次取出

  - `搭配連線池套件，close 方法被 override 為規還到池子的動作了`

# 連線池機制優點

1. `實作快速`(搭配套件與設定的方式即可使用)
2. 系統`效能`的`提升`(對連線進行重複使用的管理)
3. `解決`交易`連線共用`問題(每個 user 都可取得專屬於自己的連線)
4. `好維護`(不需要太多的程式碼即可完成，移植性佳)
