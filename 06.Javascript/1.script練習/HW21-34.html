<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <title>圖片上傳預覽</title>
    <style type="text/css">
      .container {
        padding: 10px;
        border: 1px black solid;
        width: 900px;
      }
      .row {
        padding: 4px;
      }
      .row label {
        font-weight: 500;
        margin-right: 15px;
        margin-bottom: 15px;
      }
      .row textarea {
        width: 97%;
        height: 500px;
        color: blue;
      }
      .row span {
        color: blue;
      }
      .hidden {
        display: none;
      }
      #del {
        padding: 7px;
        margin: 10px 0;
        width: 70px;
        border: 1px solid #ddd;
        border-radius: 5px;
        text-align: center;
        font-size: 0.75rem;
        color: #bdbdbd;
      }
      .imgBox {
        display: flex;
      }
      #preview {
        display: flex;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <label>請上傳圖片檔案: </label>
        <!-- 這裡一定要有一個<input type="file">的元素，當上傳點 -->
        <input type="file" id="myFile" multiple />
      </div>
      <div class="row">
        <label>檔案名稱：</label>
        <input type="text" name="filename" id="filename" />
      </div>
      <div class="row">
        <label>檔案內容: </label>
        <div id="del">刪除圖片</div>
        <div id="preview"></div>
      </div>
    </div>

    <script type="text/javascript">
      // 題目： 請製作可以同時上傳多張圖片到前端預覽的功能
      // 學習重點：
      // 1. File API – Read as Data URL

      function init() {
        // 1. 抓取DOM元素
        let myFile = document.getElementById('myFile');
        let filename = document.getElementById('filename');
        let preview = document.getElementById('preview');
        let del = document.getElementById('del');
        let files;
        // 2. 對myFile物件註冊change事件 - 改變選擇的檔案時觸發
        myFile.addEventListener('change', function (e) {
          files = e.srcElement.files;
          if (files) {
            for (let i = 0; i < files.length; i++) {
              let file = files[i];
              if (file.type.indexOf('image') > -1) {
                filename.value += `${
                  !filename.value ? file.name : ',' + file.name
                }`;
                let reader = new FileReader();
                // 在FileReader物件上註冊load事件 - 載入檔案的意思
                reader.addEventListener('load', function (e) {
                  let result = e.target.result;
                  let label = document.createElement('label');
                  let img = document.createElement('img');
                  let input = document.createElement('input');
                  // 添加class
                  label.className = 'imgBox';
                  label.setAttribute('data-index', i);
                  // 添加圖片資訊
                  img.src = result;
                  img.style.maxHeight = '200px';
                  // 添加輸入框資料
                  input.setAttribute('type', 'checkbox');
                  input.setAttribute('name', 'selectPic');
                  // 添加輸入框
                  label.append(input);
                  // 添加圖片
                  label.append(img);

                  preview.append(label);
                });
                reader.readAsDataURL(file);
              } else {
                alert('請上傳圖片！');
              }
            }
          }
        });
        Array.prototype.removeByValue = function (val) {
          for (var i = 0; i < this.length; i) {
            if (this[i] == val) {
              this.splice(i, 1);
              break;
            }
          }
        };
        del.addEventListener('click', function deletePic() {
          let checkbox = document.querySelectorAll(
            '[name="selectPic"]:checked'
          );
          let parentNode;
          for (let i = 0; i < checkbox.length; i++) {
            delete files[
              checkbox[i].closest('.imgBox').getAttribute('data-index')
            ];
            parentNode = checkbox[i].closest('.imgBox');
            parentNode.remove();
          }
        });
      }

      window.onload = init;
    </script>
  </body>
</html>
