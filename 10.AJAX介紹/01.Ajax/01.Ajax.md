- **同步**，需要等待別人的進行(JSP 是非同步)，**ex. 中壢天晟醫院網站**
- **非同步**，執行完後會通知說執行完成，**ex. 博客來網站**
  - 頁面左上再轉圈就是指同步，只需要看到部分資料
    但站台在資料都顯示完後才可看站台
- AJAX 的蓬勃發展跟 [google suggest](https://www.inside.com.tw/article/2884-google-autocomplete) 技術相關
- XML 早期是用來做訊息紀錄(ex.MSN 對話紀錄)，**從資料交換轉至資料儲存**

# 取得 getAllResponseHeaders 資訊

```cs
"D:\JQuery\apache-tomcat-9.0.36\webapps\AjaxLab_EA102\GetAllResponseHeaders.html"
```

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>GetAllResponseHeaders</title>
  </head>
  <body>
    <input
      type="button"
      value="getAllResponseHeaders"
      onclick="getAllResponseHeaders()"
    />
    <div id="showPanel"></div>

    <script>
      var xhr = null;

      function createXHR() {
        var xhr = null;
        if (window.XMLHttpRequest) {
          xhr = new XMLHttpRequest();
        } else if (window.ActiveXObject) {
          xhr = new ActiveXObject('Microsoft.XMLHTTP');
        }

        return xhr;
      }

      function stateChanged() {
        console.log(xhr.readyState);
        //server端處理完畢了没
        if (xhr.readyState == 4) {
          //request做成功了嗎
          if (xhr.status == 200) {
            alert(xhr.getAllResponseHeaders());
          } else {
            alert(xhr.status);
          }
        }
      }

      function getAllResponseHeaders() {
        xhr = createXHR();
        if (xhr == null) {
          alert('Does not support Ajax...');
          return;
        }

        //設定好回呼函式
        xhr.onreadystatechange = stateChanged;

        //建立好Get連接
        xhr.open('get', 'GetAllResponseHeaders.jsp', true);

        //送出請求
        xhr.send(null);
      }
    </script>
  </body>
</html>
```

- 回應的資料，如果在此頁面結構中也寫了 html 的資料，則整頁資料也都會一起傳過去

```cs
"D:\JQuery\apache-tomcat-9.0.36\webapps\AjaxLab_EA102\GetAllResponseHeaders.jsp"
```

```cs
<%@page contentType="text/html;charset=utf-8" %>
<%
response.setHeader("Pragma","no-cache");
response.setHeader("Cache-Control","no-cache");
response.setDateHeader("Expires",0);
%>
```

# GET 發送請求

```cs
"D:\JQuery\apache-tomcat-9.0.36\webapps\AjaxLab_EA102\GetResponseText.html"
```

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>使用Get請求方式取得回應字串</title>
  </head>
  <body>
    帳號:<input type="text" name="memId" id="memId" />
    <input type="button" value="取得名字" id="btn" />

    <div id="showPanel"></div>

    <script>
      function getInfo() {
        //===實作(填入程式碼)
        let xhr = new XMLHttpRequest();

        //設定好回呼函數
        xhr.onreadystatechange = function () {
          if (xhr.readyState == XMLHttpRequest.DONE) {
            // server 順利執行完畢
            if (xhr.status == 200) {
              memId.innerText = xhr.responseText;
            } else {
              alert(xhr.status);
            }
          }
        };

        //建立好Get連接與送出請求
        let url = 'GetResponseText.jsp?memId=' + memId.value;
        xhr.open('get', url, true);
        xhr.send(null);
      } //function

      window.addEventListener(
        'load',
        function () {
          document.getElementById('btn').onclick = getInfo;
        },
        false
      );
    </script>
  </body>
</html>
```

```cs
"D:\JQuery\apache-tomcat-9.0.36\webapps\AjaxLab_EA102\GetResponseText.jsp"
```

```cs
<%@page contentType="text/html;charset=UTF-8"%>
<%
  String memId = request.getParameter("memId");
  String memName="";

  if( memId.equals("Sara"))
    memName = "董董";
  else if( memId.equals("Amy"))
    memName = "婷婷";
  else
    memName = "查無此人";
%>
<%=memName%>
```

# POST 發送請求

```cs
"D:\JQuery\apache-tomcat-9.0.36\webapps\AjaxLab_EA102\PostResponseText.html"
```

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>使用POST請求方式取得回應字串</title>
  </head>

  <body>
    帳號:<input type="text" name="memId" id="memId" />
    <input type="button" value="取得名字" id="btn" />

    <div id="showPanel"></div>
    <script>
      function getInfo() {
        var xhr = new XMLHttpRequest();
        //設定好回呼函數
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4) {
            if (xhr.status == 200) {
              document.getElementById('showPanel').innerHTML = xhr.responseText;
            } else {
              alert(xhr.status);
            } //xhr.status == 200
          } //xhr.readyState == 4
        }; //onreadystatechange

        //建立好Post連接
        xhr.open('post', 'PostResponseText.jsp', true);
        //post 一定要設定此資訊，否則ajax不知道你要請求怎樣的資訊，會產生500
        xhr.setRequestHeader(
          'content-type',
          'application/x-www-form-urlencoded'
        );
        //送出請求
        let data_info = `memId=${memId.value}`;
        xhr.send(data_info);
      } //function

      window.addEventListener(
        'load',
        function () {
          document.getElementById('btn').onclick = getInfo;
        },
        false
      );
    </script>
  </body>
</html>
```

```cs
"D:\JQuery\apache-tomcat-9.0.36\webapps\AjaxLab_EA102\PostResponseText.jsp"
```

```cs
<%@page contentType="text/html;charset=utf-8"%>
<%
  String memId = request.getParameter("memId");
  String memName="";

  if( memId.equals("Sara"))
    memName = "董董";
  else if( memId.equals("Amy"))
    memName = "婷婷";
  else
    memName = "查無此人";
%>
<%=memName%>
```

# POST 方法的簡化

```cs
"D:\JQuery\apache-tomcat-9.0.36\webapps\AjaxLab_EA102\PostResponseText.html"
```

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>使用POST請求方式取得回應字串</title>
  </head>

  <body>
    帳號:<input type="text" name="memId" id="memId" />
    <input type="button" value="取得名字" id="btn" />

    <div id="showPanel"></div>
    <script>
      function getInfo() {
        var xhr = new XMLHttpRequest();
        //設定好回呼函數
        xhr.onreadystatechange = function () {
          console.log('onreadystatechange : ', xhr.readyState);
          if (xhr.readyState == XMLHttpRequest.DONE) {
            if (xhr.status == 200) {
              document.getElementById('showPanel').innerHTML = xhr.responseText;
            } else {
              alert(xhr.status);
            } //xhr.status == 200
          } //xhr.readyState == 4
        }; //onreadystatechange

        xhr.onload = function () {
          console.log('onload : ', xhr.readyState);
        };

        //建立好Post連接
        xhr.open('post', 'PostResponseText.jsp', true);
        //post 一定要設定此資訊，否則ajax不知道你要請求怎樣的資訊，會產生500
        xhr.setRequestHeader(
          'content-type',
          'application/x-www-form-urlencoded'
        );
        //送出請求
        let data_info = `memId=${memId.value}`;
        xhr.send(data_info);
      } //function

      window.addEventListener(
        'load',
        function () {
          document.getElementById('btn').onclick = getInfo;
        },
        false
      );
    </script>
  </body>
</html>
```

```cs
"D:\JQuery\apache-tomcat-9.0.36\webapps\AjaxLab_EA102\PostResponseText.jsp"
```

```cs
<%@page contentType="text/html;charset=utf-8"%>
<%
  String memId = request.getParameter("memId");
  String memName="";

  if( memId.equals("Sara"))
    memName = "董董";
  else if( memId.equals("Amy"))
    memName = "婷婷";
  else
    memName = "查無此人";
%>
<%=memName%>
```

# XML 簡說

- XML 文檔可對 DTD 或 XML Schema 進行引用。
- 此格式又被稱為俄羅斯套娃
- www.w3.org/2001/XMLSchema 表示，此 xsd 檔案的解釋方式依照此文件中的說明

```xml
<?xml version="1.0" ?>
<!-- booksOrder 中有子元素依序為:orderId ,memId, title, totalAmount, item-->
<!-- 其中, orderId,memId,title均為字串型別-->
<!--       totalAmount為非負的整數型別-->
<!-- item,最少要有一個,可以有很多個-->

<!-- item中有子元素依序為:bookId ,bookName, price, quantity-->
<!-- 其中, bookId ,bookName,均為字串型別-->
<!--       price為非負的整數, quantity為正整數型別-->
<xsd:schema xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <xsd:element name="booksOrder">
    <xsd:complexType>
      <xsd:sequence>
        <xsd:element name="orderId" type="xsd:string" />
        <xsd:element name="memId" type="xsd:string" />
        <xsd:element name="title" type="xsd:string" />
        <xsd:element name="totalAmount" type="xsd:nonNegativeInteger" />
        <xsd:element name="item" minOccurs="1" maxOccurs="unbounded">
          <xsd:complexType>
            <xsd:sequence>
              <xsd:element name="bookId" type="xsd:string" />
              <xsd:element name="bookName" type="xsd:string" />
              <xsd:element name="price" type="xsd:nonNegativeInteger" />
              <xsd:element name="quantity" type="xsd:positiveInteger" />
            </xsd:sequence>
          </xsd:complexType>
        </xsd:element>
      </xsd:sequence>
    </xsd:complexType>
  </xsd:element>
</xsd:schema>
```

- 而在 W3C 的建議下，開發者應該撰寫一隻 API，其中的描述應該通用且易懂。
  **因此也產生了 DOM** (Document Object Model)

# 讀取 XML 資料並生成 table

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>操作DOM XML文件</title>
    <style>
      .empTable th {
        background-color: pink;
      }
      .empTable td {
        border: 1px dotted pink;
      }
    </style>
  </head>
  <body>
    <input type="button" value="顯示員工資料" onclick="getXML();" id="btn" />
    <div id="showPanel"></div>

    <script>
      getXML();

      function showEmps(doc) {
        var table, tr, th, td, tag, textNode, text;
        let fields = doc.documentElement.childNodes;

        table = document.createElement('table');
        for (let i = 0; i < fields.length; i++) {
          // 排除 Node Type 是 TEXT_NODE 的情形
          if (fields[i].nodeType == Node.ELEMENT_NODE) {
            // 產生一列
            tr = document.createElement('tr');
            table.appendChild(tr);
            // 產生左邊格
            th = document.createElement('th');
            tr.appendChild(th);

            textNode = document.createTextNode(fields[i].nodeName);
            th.appendChild(textNode);
            // 產生右邊格
            td = document.createElement('td');
            tr.appendChild(td);

            textNode = document.createTextNode(fields[i].firstChild.nodeValue);
            td.appendChild(textNode);
          }
        }

        table.setAttribute('class', 'empTable');

        let btn = document.getElementById('btn');
        // 添加在 btn 之前
        document.body.insertBefore(table, btn);
        // 添加在 showPanel 中
        // document.getElementById('showPanel').appendChild(table);
      } //function showEmps

      function getXML() {
        //===實作(填入程式碼)
        var xhr = new XMLHttpRequest();
        //設定好回呼函數
        xhr.onload = function () {
          if (xhr.status == 200) {
            showEmps(xhr.responseXML);
          } else {
            alert(xhr.status);
          } //xhr.status == 200
        }; //onload

        //建立好Get連接與送出請求
        var url = 'JONES.xml';
        xhr.open('Get', url, true);
        //送出請求
        xhr.send(null);
      } //function
    </script>
  </body>
</html>
```

```xml
<?xml version="1.0" encoding="utf-8" ?>
<emp>
  <empno>7566</empno>
  <ename>JONES</ename>
  <job>MANAGER</job>
  <mgr>7839</mgr>
  <hiredate>1981-04-02</hiredate>
  <sal>2975</sal>
  <deptno>20</deptno>
</emp>
```

# 讀取資料後的進階

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>操作DOM XML文件</title>
    <style>
      .empTable th {
        background-color: pink;
      }
      .empTable td {
        border: 1px dotted pink;
      }
    </style>
  </head>
  <body>
    <input type="button" value="顯示員工資料" onclick="getXML();" id="btn" />
    <div id="showPanel"></div>

    <script>
      getXML();

      function showEmps(doc) {
        var table, tr, th, td, tag, textNode, text;
        let fields = doc.documentElement.children;

        table = document.createElement('table');
        for (let i = 0; i < fields.length; i++) {
          // 產生一列
          tr = document.createElement('tr');
          table.appendChild(tr);
          // 產生左邊格
          th = document.createElement('th');
          tr.appendChild(th);

          textNode = document.createTextNode(fields[i].nodeName);
          th.appendChild(textNode);
          // 產生右邊格
          td = document.createElement('td');
          tr.appendChild(td);

          textNode = document.createTextNode(fields[i].firstChild.nodeValue);
          td.appendChild(textNode);
        }

        table.setAttribute('class', 'empTable');

        let btn = document.getElementById('btn');
        // 添加在 btn 之前
        document.body.insertBefore(table, btn);
        // 添加在 showPanel 中
        // document.getElementById('showPanel').appendChild(table);
      } //function showEmps

      function getXML() {
        //===實作(填入程式碼)
        var xhr = new XMLHttpRequest();
        //設定好回呼函數
        xhr.onload = function () {
          if (xhr.status == 200) {
            showEmps(xhr.responseXML);
          } else {
            alert(xhr.status);
          } //xhr.status == 200
        }; //onload

        //建立好Get連接與送出請求
        var url = 'JONES.xml';
        xhr.open('Get', url, true);
        //送出請求
        xhr.send(null);
      } //function
    </script>
  </body>
</html>
```

```xml
<?xml version="1.0" encoding="utf-8" ?>
<emp>
  <empno>7566</empno>
  <ename>JONES</ename>
  <job>MANAGER</job>
  <mgr>7839</mgr>
  <hiredate>1981-04-02</hiredate>
  <sal>2975</sal>
  <deptno>20</deptno>
</emp>
```

# 新增與刪除清單

```cs
"D:\JQuery\apache-tomcat-9.0.36\webapps\AjaxLab_EA102_C\dom_spot\add_spot.html"
```

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Examples</title>
  </head>
  <body>
    <img src="add_2.png" id="btnAddSpot" />
    <form id="myForm">
      <div class="spot" style="display: none;">
        景點<input type="text" name="spot" /><img src="trash.png" />
      </div>
      <input type="submit" id="btnSend" value="送出" />
    </form>
    <script type="text/javascript">
      function $id(id) {
        return document.getElementById(id);
      }

      function addSpot() {
        let myForm = document.getElementById('myForm');
        let btnSend = document.getElementById('btnSend');
        let spot = document.getElementsByClassName('spot')[0];
        let newSpot = spot.cloneNode(true);
        newSpot.style.display = 'block';
        newSpot.getElementsByTagName('img')[0].onclick = removeSpot;

        myForm.insertBefore(newSpot, btnSend);
      }

      function removeSpot(e) {
        document.getElementById('myForm').removeChild(e.target.parentNode);
      }

      window.addEventListener(
        'load',
        function () {
          //-------------------------------btnAddSpot.onclick
          document.getElementById('btnAddSpot').onclick = addSpot;
          document.querySelector('.spot img').onclick = removeSpot;
        },
        true
      );
    </script>
  </body>
</html>
```

---

參考鏈接:

- [XMLHttpRequest.readyState](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/readyState)
- [XML Schema 教程](https://www.w3school.com.cn/schema/schema_howto.asp)
